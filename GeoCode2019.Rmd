---
title: "Geocode2019"
author: "Alan Jackson"
date: "January 7, 2019"
output: html_document
---

```{r setup, include=FALSE}

library(data.table)
library(tidyverse)
library(stringr)
library(dplyr)
library(ggmap)
library(lubridate)

options(stringsAsFactors = FALSE)

apikey <- readRDS("~/Dropbox/CrimeStats/apikey.rds")
register_google(key = apikey)

HoustonBdy <- c(-95.789963, 29.518566, -95.005814, 30.117875)
BoundBox <- "bounds=29.518566,-95.789963|30.117875,-95.005814"

district <- "16e"
reclean <- c(paste0("District",district,"ReCleanData.rds"))
recleanpath <- "~/Dropbox/CrimeStats/"

dflist <- vector(mode = "list", length = 2)
for (i in 1:1) {
    dflist[[i]] <- as.tibble(readRDS(paste0(recleanpath, reclean[i])))
}

BeatToZip <- as.tibble(readRDS("~/Rprojects/CrimeStats/BeatToZip.rds"))

knitr::opts_chunk$set(echo = TRUE)
```

```{r define functions}

#     Create dictionary data frame of pattern/replacement
Makedict <- function(dictionary) {
  dict <- cbind.data.frame(split(dictionary, rep(1:2, times=length(dictionary)/2)), stringsAsFactors=F)
  names(dict) <- c("From", "To")
  return(dict)
}

#   test the searches first to see what they will find
testregex <- function(dframe, col, pat) { # input data frame and regex
  for(i in 1:length(pat[,1])) {
    print(paste("Pattern: ",pat[i,1]))
    hits <- unique(dframe[[col]][grepl(pat[i,1],dframe[[col]])])
    if (length(hits)>0){
      print(paste("   Result: ", hits))
    }
    else {
      print("No hits")
    }
  }
}

#   apply to input array
applyregex <- function(dframe, col, pat) {
  for(i in 1:length(pat[,1])) {
  dframe[[col]] <- str_replace_all(dframe[[col]],pat[i,1],pat[i,2])
  }
  return(dframe)
}

#   Following is sample of how to apply

#  dictionary <- c(
#                  " *P*O* BOX\\s\\d* *","",
#                  " *BOX\\s\\d* *","",
#                  "P *O BX",""
#  )
#  dict <- Makedict(dictionary)
#  #   test them first
#  testregex(df2, "Street", dict)
#  #   Apply
#  df2 <- applyregex(df2, "Street", dict)

```


Call sequence is

* address (required): street number and street name (1234 N Main ST)
* city (optional): City name. If both city and zip are given, they may conflict.
* state (optional): State 2-letter postal abbreviation
* zip (optional): 5 digit US Postal Zipcode

Either city and state, or zip is required

Will return the last match if there are multiple matches. That way downtown Houston will not show up as "Clutch City".

Returns will be:

* status code: 
  + "success"=success 
  + "multiples"=success but multiple answers
  + "partial match"=success but not a 100% match with input address 
  + "fail"=fail
* matching address
* lat
* long
* tract
* block

```{r census geocoder}

###############################################################
#############   GetResult
###############################################################
GetResult <- function(urlreq) {
  #  required libraries 
  
  require(httr)
  
  #   set up to retry twice on server type error (which usually works)
  attempt <- 1
  result <- data.frame(status_code=0)
  while(result$status_code!=200 && attempt<=3 ) {
    if (attempt>1){print(paste("attempted", attempt))}
    attempt <- attempt + 1
    try(
      #     Go get result
      result <- httr::GET(urlreq)
    )
  }
  return(result)
}
###############################################################
#############   Census_decoder
###############################################################
Census_decoder <- function(address, city=NA, state=NA, zip=NA){
  
  urlreq <- paste0("https://geocoding.geo.census.gov/geocoder/geographies/address?street=",gsub(" ", "+",address))
  if (!is.na(city)){urlreq <- paste0(urlreq,"&city=", city)}
  if (!is.na(state)){urlreq <- paste0(urlreq,"&state=", state)}
  if (!is.na(zip)){urlreq <- paste0(urlreq,"&zip=", zip)}
  urlreq <- paste0(urlreq,"&benchmark=Public_AR_Current&vintage=Current_Current&format=json")
  
  print(urlreq)
  result <- GetResult(urlreq)
  #     did we succeed?
  if (result$status_code != 200) { # failure
    return(data.frame(
      status=paste("fail_code: ",result$status_code),
      match_address=NA,
      lat=NA,
      long=NA,
      tract=NA,
      block=NA
    ))
  } else {
  result <- httr::content(result)
  Num_matches <- length(result[["result"]][["addressMatches"]])
  
  if (Num_matches <= 0) { # failed to find address
    return(data.frame(
      status="fail_length",
      match_address=NA,
      lat=NA,
      long=NA,
      tract=NA,
      block=NA
    ))
  }
    
    # pick matching result if multiples offered
  for (i in 1:Num_matches) {
    temp <- result[["result"]][["addressMatches"]][[i]]
    if (grepl(address, 
        str_split(temp[["matchedAddress"]], ",")[1])) { break }
  }
    tract <- temp[["geographies"]][[
                   "2010 Census Blocks"]][[1]][["TRACT"]]
    if (is.null(tract)){
      return(data.frame(
        status="fail_tract",
        match_address=NA,
        lat=NA,
        long=NA,
        tract=NA,
        block=NA
      ))
    }
    status <- "success"
    match_address=temp[["matchedAddress"]] 
    lat=temp[["coordinates"]][["y"]]
    long=temp[["coordinates"]][["x"]]
    tract=temp[["geographies"]] [[
                "2010 Census Blocks"]][[1]][["TRACT"]]
    block=temp[["geographies"]] [[
                "2010 Census Blocks"]][[1]][["BLOCK"]]
    
    return(data.frame(
      status=status,
      match_address=match_address,
      lat=lat,
      long=long,
      tract= tract,
      block=block
    ))
  } # end if/else
}
```

##   Street name cleanup functions

```{r cleanup functions}

# address of form [0-9]+ [NSEW] name suffix , city, state, zip, USA
getstreet <- function(address) {
  x <- unlist(strsplit(unlist(address), ","))
  street <- trimws(sub("^[0-9]+", "", x[1]))
  return(street)
}

# address of form [0-9]+ [NSEW] name suffix , city, state, zip, USA
getaddress <- function(address) {
  x <- unlist(strsplit(unlist(address), ","))
  address <- trimws(x[1])
  return(address)
}

# address of form [0-9]+-[0-9]+ [NSEW] name suffix , city, state, zip, USA
getnumber <- function(address) { # get first number
  x <- unlist(strsplit(unlist(address), ","))
  number <- trimws(sub("^[0-9]+", "", x[1]))
  return(number)
}

# address of form [0-9]+-[0-9]+ [NSEW] name suffix , city, state, zip, USA
getoldstreet <- function(address) {
  x <- unlist(strsplit(unlist(address), ","))
  street <- trimws(sub("^[0-9]+-[0-9]+", "", x[1]))
  return(street)
}

# pull final string off street and test if is a valid suffix
getsuffix <- function(street) {
  suffixes <- c("FWY", "CIR", "ST", "RD", "DR", "AVE", "LN", "BLVD",
               "PL", "CT", "PKWY", "TER", "LNDG", "WAY", "TRL",
               "FREEWAY", "CIRCLE", "STREET", "ROAD", "DRIVE",
               "AVENUE", "LANE", "BOULEVARD", "PLACE", "COURT", "PARKWAY",
               "TERRACE", "LANDING", "WAY", "TRAIL")
  suffix <- tail(unlist(strsplit(street,split=" ")),1)
  if (any(suffix==suffixes)) {
    return(suffix)
  } else {return(" ")}
}

```

## Prep data

1. reduce to unique addresses
2. apply edits


```{r prep data}

# Read in clean data files

df <- dplyr::bind_rows(dflist)


  # create address in df: 
  # Block_Range + Suffix + Street + Type + ", Houston, TX"

df$Address <- paste(df$Block_Range, df$Suffix, df$Street, df$Type, ", Houston , TX")
df$Address <- str_replace_all(df$Address, "- ", "")
df$Address <- str_replace_all(df$Address, "  ", " ")

# flag records not matchable

df <- df %>% 
  mutate(geocode_status=case_when(
    grepl("^UNK", Block_Range) ~ "not possible",
    grepl(" NA ", Address)     ~ "not possible",
    grepl("^UNK ", Address)    ~ "not possible",
    grepl("HOMELESS", Address)    ~ "not possible",
    grepl("P\\s?O\\s?BOX", Address)    ~ "not possible",
    TRUE                       ~ "pending"
      )
    )

# Apply edits to Address field

# Make a list of unique addresses and beats for pending and count

unmatched <- df %>%
  filter(geocode_status=="pending") %>%
  mutate(RawAddress=Address) %>% 
  add_count(Address, Beat) %>% 
  select(RawAddress, Address, Beat, n, geocode_status) %>%  
  distinct() %>% 
  arrange(-n) # focus on most important first

# Puff up unmatched with empty columns

unmatched <- 
  unmatched %>% 
  mutate(match_address=NA,
         lat=NA,
         long=NA,
         tract=NA,
         block=NA,
         status="pending",
         GType=NA)

#    add newstreet field

unmatched <- 
  unmatched %>% 
  rowwise() %>% 
  mutate(newstreet=getoldstreet(Address)) 

unmatched <- unmatched %>% select(Address:newstreet, RawAddress)
```

##  start here to reprocess old file

```{r read in complete file to reprocess}

unmatched <- readRDS("~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")
unmatched <- unmatched %>%
  arrange(-n) # focus on most important first
```


###   did match previously succeed?

```{r check for previous hits}

#previous_match <- readRDS( "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")
permitdb <- readRDS( "~/Dropbox/CrimeStats/PermitDB_Geocode.rds")
permitdb <- permitdb %>% 
  mutate(Beat="UNK",n=1, geocode_status="permitdb", status="success")

generated <- readRDS( "~/Dropbox/CrimeStats/Generated_Coordinates.rds")
#   somehow I lost a space
#generated <- generated %>% 
#  mutate(Address=str_replace(Address,"Houston ,", "Houston,"))

check_match <- function(test_Address, testdata){
    # Did I already succeed at this match somewhere?
    a <- testdata %>% filter(test_Address == Address,
                              status=="success" )
    if (nrow(a)>0){
      return(a)
    } else {return(FALSE)}
}

#   usage:
#   a <- check_match(unmatched[i,], previous_match)
#   if (is_tibble(a)) {unmatched[i,4:10] <- a[1,4:10]
#      print("found previous match")}

```


##  Census Geocoding

Call census geocoder for address, and on success
add in the lat long values as well as other good stuff.

```{r do geocoding}

###############################################################
#############   getlatlong
###############################################################
getlatlong <- function(addr, beat, newaddr){
  x <- unlist(strsplit(unlist(addr), ","))
  city <- trimws(x[2])
  state <- trimws(x[3])
  adr <- unlist(strsplit(str_extract(x[1], "^[0-9]+-[0-9]+"),"-"))[1]
  adr <- str_replace(adr, "00$", newaddr)
  adr <- str_replace(adr, "^0$", newaddr)
  street <- trimws(sub("^[0-9]+-[0-9]+", "", x[1]))
  
  # Pull list of potential zipcodes
  
  ziplist <- BeatToZip[BeatToZip$beat==beat,][2]
  
  # try the various potential zipcodes
  
  keepzip <- NA
  for (zip in unlist(ziplist)) {
    loc <- Census_decoder(paste(adr, street), city, state, zip)
    if (loc[1] != "success"){ # try across the street
      adrplus <- as.character(as.numeric(adr)+1)
      loc <- Census_decoder(paste(adrplus, street), city, state, zip)
    }
    if (loc[1] == "success") {
        # does the street match?
        x <- unlist(strsplit(loc$match_address, ","))
        newstreet <- trimws(sub("^[0-9]+", "", x[1]))
        if (grepl(street, newstreet)) {
          #   sometimes it returns a new zip. Accept the new one.
          keepzip <- x[4]
          
          break # success - break out of loop
        }
    }
  }
  
  # if we couldn't get this test to succeed, then give up.
  
  if (is.na(keepzip)) {
    print("===========")
    print("zip failure")
    print("===========")
    return(data.frame(
      status="fail on zip",
      match_address=x[1],
      lat=NA,
      long=NA,
      tract=NA,
      block=NA
    ))
  }

  #   return data
  
  return(data.frame(
    status="success",
    match_address=loc$match_address,
    lat=loc[3],
    long=loc[4],
    tract=loc[5],
    block=loc[6]
  ))
  
}

```
##    take care of some special cases - Malls


```{r Some special cases}

#  Places that the geocoding generally fails because the addresses 
#  fail to have much meaning, parks, golf courses, malls, etc.

unmatched2 <- unmatched # just in case

###############   special case function
special_case <- function(mydf, mask, address, lat, long){
  if (sum(mask)>0){
    print(paste(sum(mask), "records changed"))
    mydf[mask,]$match_address <- address
    mydf[mask,]$status    <- "success"
    mydf[mask,]$geocode_status    <- "manual"
    mydf[mask,]$lat    <- lat
    mydf[mask,]$long   <- long
    mydf[mask,]$GType    <- "RANGE_INTERPOLATED manual"
  }
  return(mydf)
}
#################

mask <- grepl("W MEMORIAL LOOP", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "2000 W Memorial Loop Dr, Houston, TX 77007, USA",
                29.774177,
                -95.442344)

mask <- grepl("9 MEMORIAL LOOP", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "1000 Memorial Loop Dr, Houston, TX 77007, USA",
                29.775845,
                -95.431376)

mask <- grepl("N PICNIC LN", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "6000 N Picnic Ln, Houston, TX 77007, USA",
                29.76546,
                -95.4448)

mask <- grepl("S PICNIC LN", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "500 S Picnic Ln, Houston, TX 77007, USA",
                29.763081,
                -95.442344)

mask <- grepl("-7\\d{3} MEMORIAL DR", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "7500 Memorial Dr, Houston, TX 77007, USA",
                29.766523,
                -95.442661)

mask <- grepl("-199 E MEMORIAL LOOP DR", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "150 E Memorial Loop Dr, Houston, TX 77007, USA",
                29.764794,
                -95.431154)

mask <- grepl("-68\\d{2} MEMORIAL DR", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "6850 Memorial Dr, Houston, TX 77007, USA",
                29.765306,
                -95.432661)

mask <- grepl("-2499 KATY FWY", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
                "2450 Katy Fwy, Houston, TX 77007, USA",
                29.776653,
                -95.386089)

mask <- grepl("-6[12]\\d{2} HERMANN PARK DR", unmatched$Address)
unmatched <- special_case(unmatched, 
                mask,
               "6200 Hermann Park Dr, Houston, TX 77030, USA",
                29.715294,
                -95.389267)

mask <- grepl("-5999 HERMANN PARK DR", unmatched$Address) |
        grepl("-6099 HERMANN PARK DR", unmatched$Address) 
unmatched <- special_case(unmatched, 
                mask,
               "6000 Hermann Park Dr, Houston, TX 77030, USA",
                29.719581,
                -95.388151)

mask <- grepl("-5599 HERMANN PARK DR", unmatched$Address) 
unmatched <- special_case(unmatched, 
                mask,
                "5555 Hermann Park Dr, Houston, TX 77030, USA",
                29.721264,
                -95.389820)

mask <- grepl("GOLF COURSE DR", unmatched$Address) 
unmatched <- special_case(unmatched, 
                mask,
               "6000 Golf Course Dr, Houston, TX 77084, USA",
                29.832923,
                -95.637641)

mask <- grepl("ZOO CIRCLE DR", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "1650 Zoo Circle Dr, Houston, TX 77030, USA",
                 29.716162,
                 -95.393259)

mask <- grepl("ALMEDA MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "12200 Gulf Fwy, Houston, TX 77034",
                 29.623665,
                 -95.226924 )

mask <- grepl("MEYERLAND PLAZA", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "4700 Beechnut St, Houston, TX 77096", 
                 29.688308, 
                 -95.461916)

mask <- grepl("GULFGATE CENTER MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "3100 Woodridge Dr, Houston, TX 77087", 
                 29.698329, 
                 -95.297094)

mask <- grepl("NORTHWEST MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "9500 Hempstead Rd, Houston, TX 77092", 
                 29.798849, 
                 -95.454829)

mask <- grepl("BAYLOR PLAZA", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "1255 Moursund St, Houston, TX 77030", 
                 29.709835, 
                 -95.396725)

mask <- grepl("WEST OAKS MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "1000 West Oaks Mall, Houston, TX 77082", 
                 29.733207, 
                 -95.648302)

mask <- grepl("MEMORIAL CITY MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "303 Memorial City Way, Houston, TX 77024", 
                 29.780741, 
                 -95.535961)

mask <- grepl("WILLOWBROOK MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "2000 Willowbrook Mall, Houston, TX 77070", 
                 29.960285, 
                 -95.539956)

mask <- grepl("BRAESWOOD SQUARE", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "5300 N Braeswood Blvd , Houston, TX 77096", 
                 29.679012, 
                 -95.478179)

mask <- grepl("WOODLAKE SQUARE", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "9660 Westheimer Rd, Houston, TX 77063", 
                 29.738391, 
                 -95.536788)

mask <- grepl("NORTHLINE MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "4400 North Fwy, Houston, TX 77022", 
                 29.831625, 
                 -95.379901)

mask <- grepl("GREENSPOINT MALL", unmatched$Address) 
unmatched <- special_case(unmatched, 
                 mask, 
                 "12300 North Fwy, Houston, TX 77060", 
                 29.946008, 
                 -95.410633)

mask <- grepl("BAYBROOK MALL", unmatched$Address) &
        grepl("fail", unmatched$geocode_status)
unmatched <- special_case(unmatched, 
                 mask, 
                 "300 Baybrook Mall, Friendswood, TX 77546", 
                 29.54265, 
                 -95.15321)


#   Specific road spots

specific <- tribble(
  ~block, ~street, ~number, ~lat, ~long, ~zip,
  "900-999", "Skyline Vista", "930", 29.759302, -95.377399, "Houston, TX 77019",
  "0-99", "N SAN JACINTO ST", "30", 29.762918, -95.357548, "Houston, TX 77002",
  "1100-1199", "W OREM DR", "1250", 29.627650, -95.387823, "Houston, TX 77047",
  "8000-8099", "W OREM DR", "8050", 29.625046, -95.504899, "Houston, TX 77085",
  "1100-1199", "ENTRANCE", "6604 Arnot", 29.769932, -95.429635, "Houston, TX 77007",
  "200-299", "KATY FWY", "250", 29.777888, -95.372539, "Houston, TX 77007",
"2100-2199", "KATY FWY", "2150", 29.778031, -95.379982, "Houston, TX 77007",
"1900-1999", "KATY FWY", "1950", 29.779203, -95.375940, "Houston, TX 77007",
"2000-2099", "PRESSLER ST", "2050", 29.704626, -95.407318, "Houston, TX 77030",
"1400-1499", "PRESSLER ST", "1450", 29.704416, -95.396160, "Houston, TX 77030",
"26000-26099", "EASTEX FWY", "26050", 30.071838, -95.245656, "Porter, TX 77365", 
"3400-3499", "BARKER-CLODINE RD", "3425", 29.734172, -95.688014, "Houston, TX, 77094",
"14700-14799", "WOODSON PARK DR", "14700", 29.931124, -95.203876,"Houston, TX 77044",
"14600-14699", "VILLAGE EVERGREEN TRAIL", "14650", 29.576914, -95.151576, "Houston, TX 77062",
"14700-14799", "VILLAGE EVERGREEN TRAIL", "14750", 29.575495, -95.150133, "Houston, TX 77062",
"14800-14899", "VILLAGE EVERGREEN TRAIL", "14850", 29.574021, -95.149039, "Houston, TX 77062",
"4300-4399", "WOODLAND HILLS DR", "4350", 30.075192, -95.213783, "Kingwood, TX 77339",
"2800-2899", "VICTORY DR", "2801", 29.870550, -95.452790, "Houston, TX 77088",
"2400-2499", "WALKER ST", "2400", 29.750399, -95.352220, "Houston, TX 77003",
"18400-18499", "GATEBROOK DR", "18400", 29.555526, -95.150419, "Webster, TX 77598",
"18300-18399", "GATEBROOK DR", "18350", 29.555826, -95.150728, "Webster, TX 77598",
"10700-10799", "ELLA BLVD", "10755", 29.939246, -95.432656, "Houston, TX 77067",
"7800-7899", "MORLEY ST", "7850", 29.661369, -95.277006, "Houston, TX 77061",
"4400-4499", "NORTHPARK DR", "4450", 30.070439, -95.181017, "Kingwood, TX 77345",
"2200-2299", "SOUTH FWY", "2250", 29.742508, -95.364159, "Houston, TX 77003",
"4800-4899", "GLORY LAND", "4850", 29.677277, -95.351772, "Houston, TX 77033",
"4900-4999", "GLORY LAND", "4950", 29.676764, -95.350023, "Houston, TX 77033",
"7000-7099", "NORTHWEST DR", "7050", 29.847370, -95.496132, "Houston, TX 77092",
"7200-7299", "NORTHWEST DR", "7250", 29.849742, -95.499234, "Houston, TX 77092",
"14100-14199", "SPACE CENTER BLVD", "14150", 29.591602, -95.137589, "Houston, TX 77062",
"9700-9799", "CLEARWOOD DR", "9750", 29.627978, -95.248547, "Houston, TX 77075",
"5500-5599", "TIDWELL ESTATES LANE", "5550", 29.846497, -95.432640, "Houston, TX 77091",
"1600-1699", "ZOO CIRCLE DR", "1650", 29.715758, -95.389866, "Houston, TX 77030",
"3700-3799", "SOUTHWEST FWY", "3797", 29.728644, -95.437044, "Houston, TX 77027",
"100-199", "GULF FWY", "150", 29.761877, -95.372678, "Houston, TX 77002",
"200-299", "GULF FWY", "250", 29.761063, -95.373299, "Houston, TX 77002",
"300-399", "GULF FWY", "350", 29.759926, -95.373776, "Houston, TX 77002",
"3600-3699", "W BELLFORT AVE", "3650", 29.672850, -95.435746, "Houston, TX 77025",
"1500-1599", "W BELLFORT AVE", "1550", 29.673346, -95.399771, "Houston, TX 77054",
"9500-9599", "ROWLETT RD", "9550", 29.631819, -95.234351, "Houston, TX 77075",
"2400-2499", "SAWYER HEIGHTS ST", "2450", 29.775153, -95.384886, "Houston, TX 77007",
"5600-5699", "S LAKE HOUSTON PKWY", "5650", 29.813299, -95.210692, "Houston, TX 77049",
"00-99", "W LAKE HOUSTON PKWY", "50", 30.092091, -95.191164, "Porter, TX 77365",
"5700-5799", "DEEP FOREST DR", "5750",  29.850715, -95.477162, "Houston, TX 77092",
"10400-10499", "CLUB CREEK DR", "10400", 29.689646, -95.553926, "Houston, TX 77036",
"3800-3899", "N MCCARTY ST", "3850", 29.795996, -95.272480, "Houston, TX 77029",
"0-99", "EL DORADO BLVD", "50", 29.554233, -95.152973, "Webster, TX 77598",
"13000-13099", "S MAIN ST", "13000", 29.643500, -95.473750, "Houston, TX 77085",
"0-99", "HOBBY AIRPORT LOOP", "50", 29.654723, -95.276696, "Houston, TX 77061",
"13800-13899", "BLUERIDGE RD", "13850", 29.625651, -95.492953, "Houston, TX 77085",
"5400-5499", "WHITLEY ST", "5400", 29.717909, -95.410526, "Houston, TX 77005",
"3200-3299", "E LOOP N FWY", "3299", 29.769509, -95.265411, "Houston, TX 77029",
"0-99", "W EL DORADO BLVD", "50", 29.552748, -95.154955, "Friendswood, TX 77546",
"800-899", "WOODLAND HILLS DR", "800", 30.027739, -95.209054, "Kingwood, TX 77339",
"1400-1499", "WOODLAND HILLS DR", "1450", 30.031889, -95.216047, "Kingwood, TX 77339",
"900-999", "PACIFIC ST", "950", 29.746687, -95.390529, "Houston, TX 77006",
"12200-12299", "KUYKENDAHL RD", "12250", 29.961347, -95.421399, "Houston, TX 77060",
"10800-10899", "FUQUA ST", "10800", 29.611496, -95.225305, "Houston, TX 77089",
"1800-1899", "BARKER-CLODINE RD", "1850", 29.773785, -95.685505, "Houston, TX 77094",
"3500-3599", "BARKER-CLODINE RD", "3550", 29.734850, -95.687270, "Houston, TX 77082",
"15400-15499", "DIPLOMATIC PLAZA DR", "15450", 29.940739, -95.321507, "Houston, TX 77032",
"15500-15599", "DIPLOMATIC PLAZA DR", "15550", 29.942524, -95.321534, "Houston, TX 77032",
"7600-7699", "E OREM DR", "7690", 29.625445, -95.285922, "Houston, TX 77075",
"3900-3999", "E OREM DR", "3990", 29.628765, -95.364568, "Houston, TX 77047"
)

for (i in 1:nrow(specific)) {
  mask <- grepl(paste(specific[i,]$block, specific[i,]$street), 
                unmatched$Address, ignore.case=TRUE)
  print(paste(specific[i,]$street, sum(mask)))
  unmatched <- special_case(unmatched, 
                   mask, 
                   paste0(specific[i,]$number, " ", 
                          specific[i,]$street, ", ",
                          specific[i,]$zip),
                  specific[i,]$lat, 
                  specific[i,]$long 
                   )
}

```

##  Fix Loop and Sam Houston Pkwy

```{r Fix tollway}

keep_unmatched <- unmatched

#   Use Beat to guess if it is W Sam Houston Pkwy S or N.
#   Changeover point is Buffalo Bayou
#   Changeover from W Sam to S Sam is Bellfort.
#   Changeover from S Sam E to S Sam W is 288, South Fwy
#   Google in error, thinks S Sam W is W Sam S from addresses>11,000
#
#   West Loop is W LOOP N/S FWY,   changeover is Buffalo Bayou

samWS <- c("19G10", "19G20", "19G30", "19G40", "19G50", "20G10", "20G20", "20G30", "20G40")
samWN <- c("20G50", "20G60", "5F30", "4F10", "4F20", "4F30")

samSE <- c("14D50", "13D40", "12D20")
samSW <- c("17E30", "16E30", "16E40", "17E4", "17E40", "16E20", "19G50", "16E10")

samES <- c("12D30", "12D40", "11H40", "9C40")
samEN <- c("24C60", "8C50")

samNE <- c("22B40", "22B20", "22B30", "6B50", "6B60", "7C50", "7C20", "7C40", "8C60", "8C50")

LoopWN <- c("18F10", "2A50", "5F10", "2A60", "3B10")
LoopWS <- c("18F20", "1A50", "17E10", "15E10", "15E30")

# Note 2A20 appears in NW and NE
LoopNW = c("3B10", "2A60", "3B30", "3B40")
LoopNE = c("3B50", "2A10", "3B50", "7C20", "8C30", "9C30", "9C20")

LoopEN = c("9C20", "9C30", "9C10")
LoopES = c("11H20")

# beat 15E40 has LoopSE according to ESRI, 
# but LoopSW according to Google which correct
LoopSE = c("11H30", "11H20", "13D10", "14D10", "14D30", "14D20", "14D40")
LoopSW = c("15E30", "15E10", "15E40")

PostOakN <- c("18F10", "5F10")
PostOakS <- c("18F20")

XTimberW <- c("3B40")
XTimberE <- c("3B50")

#   based on incorrect Google mapping
WBellfortBlvd <- c("19G40")
WBellfortAve <- c("19G50","17E30","17E40", "15E20", "15E10", "15E30", "15E40" )
BellfortSt <- c("14D20", "14D30", "13D20")

#   From one string to 2 outputs
Fix_Fwy <- function(dframe, mask_string, beat_a, beat_b, from_str, to_str_a, to_str_b){
  mask <- grepl(mask_string, dframe$Address)
  print(paste(sum(mask), nrow(dframe)))
  for (beat in beat_a){
    dframe$Address[mask&(dframe$Beat==beat)] <-
      str_replace(dframe$Address[mask&(dframe$Beat==beat)], from_str, to_str_a)
  }
  for (beat in beat_b){
    dframe$Address[mask&(dframe$Beat==beat)] <-
      str_replace(dframe$Address[mask&(dframe$Beat==beat)], from_str, to_str_b)
  }
  return(dframe)
}

#-----  W Loop
unmatched <- Fix_Fwy(unmatched, "W LOOP FWY ,", 
                     LoopWS, LoopWN, "FWY","S FWY", "N FWY")
#-----  E Loop
unmatched <- Fix_Fwy(unmatched, "E LOOP FWY ,", 
                     LoopES, LoopEN, "FWY","S FWY", "N FWY")
#-----  S Loop
unmatched <- Fix_Fwy(unmatched, "S LOOP FWY ,", 
                     LoopSW, LoopSE, "FWY","W FWY", "E FWY")
#-----  N Loop
unmatched <- Fix_Fwy(unmatched, "N LOOP FWY ,", 
                     LoopNW, LoopNE, "FWY","W FWY", "E FWY")
#-----  Post Oak
unmatched <- Fix_Fwy(unmatched, "9 POST OAK LN ,", 
                     PostOakN, PostOakS, "POST","N POST", "S POST")

#-----  Crosstimbers
unmatched <- Fix_Fwy(unmatched, "-199 CROSSTIMBERS ", 
                     XTimberW, XTimberE, "CROSS","W CROSS", "E CROSS")


#-----  Bellfort for google
mask <- grepl("W BELLFORT ST ,", unmatched$Address)
for (beat in WBellfortBlvd){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], " ST ", " BLVD ")
}
for (beat in WBellfortAve){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], " ST ", " AVE ")
}
for (beat in BellfortSt){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "W BELLFORT ST ", "BELLFORT ST ")
}

mask <- grepl("W BELLFORT AVE ,", unmatched$Address)
for (beat in WBellfortBlvd){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], " AVE ", " BLVD ")
}
for (beat in BellfortSt){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "W BELLFORT AVE ", "BELLFORT ST ")
}

mask <- grepl("W BELLFORT AVE ,", unmatched$Address)
unmatched$status[mask] <- "redo"
mask <- grepl("W BELLFORT ST ,", unmatched$Address)
unmatched$status[mask] <- "redo"
mask <- grepl("9 BELLFORT ST ,", unmatched$Address)
unmatched$status[mask] <- "redo"


#-----  W Sam
mask <- grepl("W SAM HOUSTON PKWY ,", unmatched$Address)
for (beat in samWS){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY S")
}
for (beat in samWN){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY N")
}

#-----  S Sam
mask <- grepl("S SAM HOUSTON PKWY ,", unmatched$Address)
for (beat in samSW){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY W")
}
for (beat in samSE){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY E")
}

#-----  N Sam
mask <- grepl("N SAM HOUSTON PKWY ,", unmatched$Address)
for (beat in samNE){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY E")
}

#-----  E Sam
mask <- grepl("E SAM HOUSTON PKWY ,", unmatched$Address)
for (beat in samEN){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY N")
}
for (beat in samES){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "PKWY", "PKWY S")
}


mask <- grepl("W SAM HOUSTON PKWY S", unmatched$Address)
for ( i in c("11500", "11600", "11700", "11800", "11900")){
unmatched$Address[mask&(grepl(i, unmatched$Address))] <- 
    str_replace(unmatched$Address[mask&(grepl(i, unmatched$Address))], 
    "W SAM HOUSTON PKWY S", "S SAM HOUSTON PKWY W")
}

mask <- grepl("W SAM HOUSTON PKWY N", unmatched$Address) &
        grepl("mismatch", unmatched$status)
unmatched$Address[mask] <- 
    str_replace(unmatched$Address[mask], " W ", " WEST ")

#-----  Sam
mask <- grepl("9 SAM HOUSTON PKWY ,", unmatched$Address)
for (beat in samWS){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "W SAM HOUSTON PKWY S")
}
for (beat in samWN){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "W SAM HOUSTON PKWY N")
}
for (beat in samSW){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "S SAM HOUSTON PKWY W")
}
for (beat in samSE){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "S SAM HOUSTON PKWY E")
}
for (beat in samNE){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "N SAM HOUSTON PKWY E")
}
for (beat in samES){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "E SAM HOUSTON PKWY S")
}
for (beat in samEN){
  unmatched$Address[mask&(unmatched$Beat==beat)] <-
    str_replace(unmatched$Address[mask&(unmatched$Beat==beat)], "SAM HOUSTON PKWY", "E SAM HOUSTON PKWY N")
}


```

##  match against census

```{r Now work through census data}


# re-edit addresses

#unmatched <- readRDS( "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

#   Spelling errors

source("Edit_Addresses.R") # load in address edits

dict <- Makedict(dictionary)
#   test them first
testregex(unmatched, "Address", dict)
#   Apply
unmatched <- applyregex(unmatched, "Address", dict)

#   Suffix errors

source("Edit_Suffixes.R") # load in suffix edits

dict <- Makedict(dictionary)
#   test them first
testregex(unmatched, "Address", dict)
#   Apply
unmatched <- applyregex(unmatched, "Address", dict)

#    special cases - digits replace last 2 on address
special <- tribble(
  ~match, ~addr,
  "MAIN",           "75",
  "BAYBROOK",          "00",
  "ALLEN",          "09",
  "KELLEY",            "14"
)

# Skip these, census won't get them, this will speed things up

skips <- c("HOMELESS", "PO BOX", "POBOX","TOMBALL", "HEMPSTEAD", "POST OAK", "1960", " SAM ", "AVENUE" , "9 , Houston")

onlys <- c(" LOOP ", " BELLFORT ")

##########################################
##    spin through data geocoding
##########################################

begin <- 1
successes <- 0
trys <- 0
starttime <- now()

for (i in begin:nrow(unmatched)) {
  if (i==begin){starttime <- now()}
#for (i in begin:(begin+498)) {
#for (i in 572:572) {
  if (unmatched[i,]$status!="success"){ # only the redo's
    # skip hopeless cases
    if (any(str_detect(unmatched[i,]$Address, skips))){next()}
    ####if (mask[i]==FALSE){next()}
    # only do selected cases
    #if (!any(str_detect(unmatched[i,]$Address, onlys))){next()}
    # only do google fails
    if (unmatched[i,]$geocode_status!="google fail"){next()}
    # only do those with a block number
    if (is.na(unmatched[i,]$block)){next()}
    trys <- trys + 1
    print(paste("--->",i,unmatched[i,1], 
                now()+((now()-starttime)/trys)*(nrow(unmatched)-i)
          ))
    # Did I already succeed at this match somewhere?
    a <- check_match(unmatched[i,]$Address, previous_match)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in archive")
      next
    }
    a <- check_match(unmatched[i,]$Address, unmatched)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in current")
      next
    }
    
    newaddr <- "30"
    newaddr <- str_pad(as.character(sample(15:40, 1)),2,pad="0")
     
    if (grepl("FWY", unmatched[i,]$Address)){newaddr <- "15"}
    
    if(any(str_detect(unmatched[i,]$Address, special$match))){
      newaddr <- special[str_detect(unmatched[i,]$Address, special$match),]$addr
    }
    
    latlong <- getlatlong(unmatched[i,]$Address, unmatched[i,]$Beat, newaddr)
    if (latlong$status=="success") {
      successes <- successes + 1
      #print(paste("=======final=======",latlong[1,]))
      unmatched[i,]$match_address  <- latlong$match_address
      unmatched[i,]$lat            <- latlong$lat
      unmatched[i,]$long           <- latlong$long
      unmatched[i,]$tract          <- latlong$tract
      unmatched[i,]$block          <- latlong$block
      unmatched[i,]$geocode_status <- "census"
      unmatched[i,]$status         <- latlong$status
    } else {
      unmatched[i,]$geocode_status <- "census fail"
      unmatched[i,]$status         <- latlong$status
    }
  }
  if ((i+1)%%100 == 0){
    saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_temp.rds")
    print(paste("successes =", successes))
    
  }
}
print(paste("successes =", successes))

saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_temp.rds")

keep_unmatched <- unmatched
unmatched <- keep_unmatched

#   Percent of unique addresses found, and percent of total found

unmatched %>% 
  group_by(status) %>% 
  summarise(n=n())

  #   Are we within the city?
for (i in 1:nrow(unmatched)){  
  if (!is.na(unmatched[i,]$lat) &
      (!between(unmatched[i,]$lat, HoustonBdy[2], HoustonBdy[4]) |
       !between(unmatched[i,]$long, HoustonBdy[1], HoustonBdy[3]))){
    print(paste("---", i))
    unmatched[i,]$geocode_status <- "census fail"
    unmatched[i,]$match_address <- NA
    unmatched[i,]$lat <- NA
    unmatched[i,]$long <- NA
    unmatched[i,]$tract <- NA
    unmatched[i,]$block <- NA
    unmatched[i,]$status <- "pending"
  }
}
```

```{r look at misses}

#   Look at the failures - first strip number and consolidate

unmatched %>% 
  filter(grepl("fail", geocode_status)) %>% 
  filter(!grepl("outside", status)) %>% 
  filter(!grepl("out of range", status)) %>% 
  filter(!grepl("Not an address", status)) %>% 
  mutate(street=sub("^[0-9]+-[0-9]+", "", Address))  %>% 
  mutate(street=trimws(str_extract(street, "[A-Z 0-9-]+")))  %>% 
  group_by(street) %>% 
  summarise(nn=sum(n)) %>% 
  arrange(-nn)
```

###  Now we will turn to Google for the rest

```{r GetLatLongGoogle}

#   Function for pulling fields out of nested lists returned by geocode
getfields <- function(x){
              if(! is.na(x) && length(x$results)>0)  {tibble(
              lat=as.numeric(x$results[[1]]$geometry$location$lat),
              long=as.numeric(x$results[[1]]$geometry$location$lng),
              match_address=x$results[[1]]$formatted_address,
              LocType=x$results[[1]]$geometry$location_type,
              Type=unlist(x$results[[1]]$types[1])
              )
              } else if ("status" %in% names(x) &&
                         x$status=="ZERO_RESULTS"){
                tibble(Type=x$status,lat=NA,long=NA,
                           match_address=NA,LocType=NA )
              } else{
                tibble(Type=NA,lat=NA,long=NA,
                           match_address=NA,LocType=NA )
              }
}

#     Process google results and check for accuracy

GetLatLongGoogle <- function(address, newaddr){
  # prepare address
  x <- unlist(strsplit(unlist(address), ","))
  city <- trimws(x[2])
  state <- trimws(x[3])
  adr <- unlist(strsplit(str_extract(x[1], "^[0-9]+-[0-9]+"),"-"))[1]
  adr <- str_replace(adr, "00$", newaddr)
  adr <- str_replace(adr, "^0$", newaddr)
  street <- trimws(sub("^[0-9]+-[0-9]+", "", x[1]))
  address <- paste(adr, street, ",", city, ",", state)
  
  #   get results from given address
  
  #GoogleResults <- geocode(address, output="all")
  GoogleResults <- geocode(address, output="all", inject=BoundBox)
  LatLong1 <- getfields(GoogleResults)
  
  #   Did we error?
  
  if (is.na(LatLong1$Type) |
      LatLong1$Type == "ZERO_RESULTS"){
          LatLong1$status <- "no result"
          return(LatLong1)
      }
  
  #   Are we within the city?
  
  if (!between(LatLong1$lat, HoustonBdy[2], HoustonBdy[4]) |
      !between(LatLong1$long, HoustonBdy[1], HoustonBdy[3])){
          LatLong1$status <- "outside boundary"
          return(LatLong1)
      }
  
  #   Is it a bogus location at center of long street?
  
  if (LatLong1$LocType == "GEOMETRIC_CENTER") { # bad location
          LatLong1$status <- "Road only, street number ignored"
          return(LatLong1)
  }
  
  # REALLY bogus location - don't want this
    
  if (LatLong1$LocType == "APPROXIMATE" ) { # bad location
          LatLong1$status <- "City only, street ignored"
          return(LatLong1)
  }
  
  #   Is the match name "close enough"?
  x <- unlist(strsplit(unlist(LatLong1$match_address), ","))
  #utstreet <- trimws(sub("^[0-9]+", "", x[1]))
  utstreet <- trimws(x[1])
  adr <- str_remove(adr, "^0")
  if (tolower(paste(adr,street)) != tolower(utstreet)){
          LatLong1$status <- "Names mismatch"
          return(LatLong1)
  }
  
  #   Now tweak the street number and get a new set
  #   unless LocType == "ROOFTOP"
  
  if (LatLong1$LocType != "ROOFTOP") { # interpolated location
      addrnumber <- trimws(str_extract(address, "^[0-9]+ "))
      if (as.numeric(addrnumber)>50){
        addrnumber2 <- as.character(as.numeric(addrnumber)-16)
      } else {
        addrnumber2 <- as.character(as.numeric(addrnumber)+16)
      }
      address <- str_replace(address, addrnumber, addrnumber2)
      GoogleResults <- geocode(address, output="all")
      LatLong2 <- getfields(GoogleResults)
        
    #   Are the answers the same? If so, we have a problem
      distance <- dist(rbind(c(LatLong1$lat, LatLong1$long),
                        c(LatLong2$lat, LatLong2$long))) *
                        69*5280
      if (distance < 10){# could be almost anywhere, reject
          LatLong1$status <- paste("Distance =",as.character(distance))
          return(LatLong1)
      }
  }
  #   All the tests passed, successful return
        LatLong1$status <- "success"
        return(LatLong1)
  
}

```


```{r add notes}

mask <- grepl("W HOWARD LN", unmatched$RawAddress)
sum(mask)
unmatched[mask,]$GType <- "Parole Board in Austin"

mask <- grepl("14000-14099 E 21ST", unmatched$Address)
sum(mask)
unmatched[mask,]$GType <- "Dept Pub Safety, Tulsa"
unmatched[mask,]$status <- "outside boundary"

mask <- grepl("HOMELESS", unmatched$Address) |
        grepl("PO BOX", unmatched$Address)
sum(mask)
unmatched[mask,]$GType <- NA
unmatched[mask,]$status <- "Not an address"

#   Flag addresses out of range

outofrange <- function(df, mask, min, max){
  number <- as.numeric(getnumber(df))
  mask2 <- (number<min)|(number>max)
  df$status[mask&mask2] <- "address out of range"
  return(df)
}

dataOOR <- tribble(
  ~street, ~min, ~max,
  "ST EMANUEL", 0, 3799,
  "RIESNER", 0, 99,
  "W MONTGOMERY RD", 5600, 11999,
  "LEY RD", 7100, 10399,
  "RUSTIC WOODS", 2800, 4199,
  "SHERMAN ST", 2900, 8099,
  "GATEBROOK DR", 18300, 19499,
  "MYKAWA RD", 5600, 12599,
  "WESTPLACE DR", 8600, 8999
)

unmatched2 <- unmatched
unmatched <- unmatched2

for (i in 1:nrow(dataOOR)){
  mask <- grepl(dataOOR$street[i], unmatched$Address)
  df2 <- unmatched[mask,] %>% 
    select(Address, status) %>% 
    mutate(number=unlist(strsplit(unlist(Address), ","))[1]) %>% 
    mutate(number=as.numeric(trimws(str_extract(number, "^[0-9]+")))) %>%  
    mutate(status = case_when(!between(number,
                                      dataOOR$min[i],
                                      dataOOR$max[i]) ~ 
                                "address out of range",
                                TRUE ~ status))
  unmatched$status[mask] <- df2$status
  
}

```




##    And here we run google

```{r run google}

# re-edit addresses

#unmatched <- readRDS( "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

#   Spelling errors

source("Edit_Addresses.R") # load in address edits

dict <- Makedict(dictionary)
#   test them first
testregex(unmatched, "Address", dict)
#   Apply
unmatched <- applyregex(unmatched, "Address", dict)

#   Suffix errors

source("Edit_Suffixes.R") # load in suffix edits

dict <- Makedict(dictionary)
#   test them first
testregex(unmatched, "Address", dict)
#   Apply
unmatched <- applyregex(unmatched, "Address", dict)


#   Edits just for Google - census doesn't like them

source("Edit_Google_Addresses.R") # load in address edits

dict <- Makedict(dictionary)
#   test them first
testregex(unmatched, "Address", dict)
#   Apply
unmatched <- applyregex(unmatched, "Address", dict)

#    special cases - digits replace last 2 on address
special <- tribble(
  ~match, ~addr,
  "KINGWOOD PL",          "25",
  "ALMEDA",          "14",
  "HUENI",          "14",
  "3899 BELLFORT",          "07",
  "6999 W BELLFORT",        "02",
  "GATEWOOD",          "34",
  "NORTHPARK",          "06",
  "PARK WEST",          "10",
  "CENTRAL GREEN BLVD",      "00"
)

# Skip these, won't get them, this will speed things up

skips <- c("HOMELESS", "PO BOX", "POBOX", "ENTRANCE", "P O BOX", 
           "99 , Houston")

onlys <- c("GATEWOOD", "ALMEDA",
           "FUQUA", "W PARK", 
           "NORTHPARK", "BELLFORT", "WAYSIDE",
           "EAST FWY", "E ALMEDA", "S LOOP")
onlys <- c("HUENI")

##########################################
##    next spin through data geocoding
##########################################

#geocodeQueryCheck()
begin <- 1
successes <- 0
trys <- 0
for (i in begin:nrow(unmatched)) {
#for (i in begin:(begin+10)) {
#for (i in 151:151) {
  if (i==begin){starttime <- now()}
  if (unmatched[i,]$status!="success"){ 
    # skip cases with no street name
    if (grepl("99 +,", unmatched[i,]$Address)){print("--no street--")
      next()}
    # skip cases outside boundary
    if (grepl("outside", unmatched[i,]$status)){print("--outside--")
      next()}
    # skip hopeless cases
    if (any(str_detect(unmatched[i,]$Address, skips))){next()}
    
    # only do selected cases
    if (!any(str_detect(unmatched[i,]$Address, onlys))){next()}
    # skip distance <10 cases
    #if (unmatched[i,]$status=="Distance = 0"){next()}
    # skip GEOMETRIC_CENTER cases
    #if(!is.na(unmatched[i,]$GType) &
    #    unmatched[i,]$GType == "GEOMETRIC_CENTER route") {next()}
    trys <- trys + 1
    print(paste("--->",i,unmatched[i,1], 
                format(Sys.time(), "%a %b %d %X %Y"),
                now()+((now()-starttime)/trys)*(nrow(unmatched)-i)
          ))
    #print(paste("--->",i,unmatched[i,1], 
    #            format(Sys.time(), "%a %b %d %X %Y")))
    # Did I already succeed at this match somewhere?
    #a <- check_match(unmatched[i,]$Address, previous_match)
    #if (is_tibble(a)) {
    #  unmatched[i,4:10] <- a[1,4:10]
    #  print("found previous match in archive")
    #  next
    #}
    a <- check_match(unmatched[i,]$Address, unmatched)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in current")
      next
    }
    a <- check_match(unmatched[i,]$Address, generated)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in generated")
      next
    }

    newaddr <- str_pad(as.character(sample(0:50, 1)),2,pad="0")
    #if (grepl("FWY", unmatched[i,]$Address)){newaddr <- "11"}
    if(any(str_detect(unmatched[i,]$Address, special$match))){
      newaddr <- special[str_detect(unmatched[i,]$Address, special$match),]$addr
    }
    
    #   Call google
    
    latlong <- GetLatLongGoogle( unmatched[i,]$Address, newaddr)
    if (latlong$status=="success") {
      #print(paste("=======final=======",latlong[1,]))
      print(paste("=======success======="))
      unmatched[i,]$match_address  <- latlong$match_address
      unmatched[i,]$lat            <- latlong$lat
      unmatched[i,]$long           <- latlong$long
      unmatched[i,]$geocode_status <- "google"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
    } else if (latlong$status=="Names mismatch"){
      print(paste("=======fail=======",latlong[1,]))
      unmatched[i,]$geocode_status <- "google fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    } else{
      print(paste("=======fail======="))
      unmatched[i,]$geocode_status <- "google fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    }
  }
  if ((i+1)%%100 == 0){
    saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_temp.rds")
    
  }
}

old <- readRDS("~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

new <- bind_rows(old, unmatched) %>% unique()
new <- unmatched %>% unique()

saveRDS(new, "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

#   Percent of unique addresses found, and percent of total found

unmatched %>% 
  group_by(geocode_status) %>% 
  summarise(n=n())


```

##    rerun google to look for bogus addresses

```{r run google again}

##########################################
##    next spin through data geocoding
##########################################

begin <- 84263
successes <- 0
trys <- 0
for (i in begin:nrow(unmatched)) {
  if (i==begin){starttime <- now()}
  if (unmatched[i,]$status=="success" &
      unmatched[i,]$geocode_status=="google"){ # only the successes

    trys <- trys + 1
    print(paste("--->",i,unmatched[i,1], 
                format(Sys.time(), "%a %b %d %X %Y"),
                now()+((now()-starttime)/trys)*(nrow(unmatched)-i)
          ))    
    
    if(!is.na(unmatched[i,]$GType) &
        grepl("ROOFTOP", unmatched[i,]$GType)) {next()}
    # Did I already succeed at this match somewhere?
    a <- check_match(unmatched[i,]$Address, unmatched)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in current")
    }
    a <- check_match(unmatched[i,]$Address, generated)
    if (is_tibble(a)) {
      unmatched[i,4:10] <- a[1,4:10]
      print("found previous match in generated")
      next
    }
    
    newaddr <- str_pad(as.character(sample(0:50, 1)),2,pad="0")
    if(any(str_detect(unmatched[i,]$Address, special$match))){
      newaddr <- special[str_detect(unmatched[i,]$Address, special$match),]$addr
    }
    
    #   Call google
    
    latlong <- GetLatLongGoogle( unmatched[i,]$Address, newaddr)
    if (latlong$status=="success") {
      #print(paste("=======final=======",latlong[1,]))
      print(paste("=======success======="))
      unmatched[i,]$match_address  <- latlong$match_address
      unmatched[i,]$lat            <- latlong$lat
      unmatched[i,]$long           <- latlong$long
      unmatched[i,]$geocode_status <- "google"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
    } else if (latlong$status=="Names mismatch"){
      print(paste("=======fail=======",latlong[1,]))
      unmatched[i,]$geocode_status <- "google fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    } else{
      print(paste("=======fail======="))
      unmatched[i,]$geocode_status <- "google fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    }
  }
  if ((i+1)%%100 == 0){
    saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_temp.rds")
    
  }
}

old <- readRDS("~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

new <- bind_rows(old, unmatched) %>% unique()

saveRDS(new, "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

#   Percent of unique addresses found, and percent of total found

unmatched %>% 
  group_by(geocode_status) %>% 
  summarise(n=n())


```

```{r test google geocode}

addrs <- c("1300-1399 TULANE ST, HOUSTON, TX",
           "1700-1799 TULANE ST, HOUSTON, TX") 

for (i in 1:2) {
    print(paste("--->",i,addrs[i]))
    newaddr <- "30"
    if (grepl("FWY", addrs[i])){newaddr <- "15"}
    
    #   Call google
    
    latlong <- GetLatLongGoogle( addrs[i], newaddr)
    if (latlong$status=="success") {
      print(paste("=======final=======",latlong[1,]))
    } else {
      print(paste("=======fail=======",latlong[1,]))
    }
}


```


```{r interpolate fwy}

Fwy_interpolate <- function(previous_match, unmatched, match_str, start, stop) {
  #   create dataframe of good lat long to interpolate with 
  dfstart <- 
  bind_rows(previous_match, unmatched) %>% 
    filter(status=="success") %>% 
    filter(grepl(tolower(match_str), tolower(match_address))) %>% 
    select(match_address, lat, long) %>%
    mutate(addr=as.numeric(str_extract(match_address, "^[0-9]+"))) %>% 
    unique() %>% 
    arrange(addr) 
    
  #   Create points to interpolate to
  dftargets <- seq(start,stop,by=100)
  
  # interpolate
  newlat <- approx(dfstart$addr, dfstart$lat, dftargets)
  newlon <- approx(dfstart$addr, dfstart$long, dftargets)
  
  #   Create a new dataframe with all "addresses" in it
  generated <- tibble(addr=newlat$x, lat=newlat$y, long=newlon$y) %>% 
    mutate(Address=paste0(as.character(addr-50),"-",
                          as.character(addr+49),
                          paste0(" ",toupper(match_str), " , Houston , TX"))) %>% 
    mutate(Beat=NA, n=0, geocode_status="generated", 
           match_address=paste0(as.character(addr)," ",match_str, ", Houston, TX"),
           tract=NA, block=NA, status="success") %>% 
    select(Address:match_address,lat, long, tract, block, status)
  return(generated)
}


katy <- Fwy_interpolate(previous_match, unmatched, "Katy Fwy", 250, 21850)
northfwy <- Fwy_interpolate(previous_match, unmatched, "North Fwy", 150, 17150)
eastex <- Fwy_interpolate(previous_match, unmatched, "Eastex Fwy", 950, 26050)
NSamE <- Fwy_interpolate(previous_match, unmatched, "N SAM HOUSTON PKWY E", 50, 9850)
SSamE <- Fwy_interpolate(previous_match, unmatched, "S SAM HOUSTON PKWY E", 3550, 12450)
ESamS <- Fwy_interpolate(previous_match, unmatched, "EAST SAM HOUSTON PKWY S", 5450, 7950)
SSamW <- Fwy_interpolate(previous_match, unmatched, "S SAM HOUSTON PKWY W", 650, 12650)
WSamS <- Fwy_interpolate(previous_match, unmatched, "W SAM HOUSTON PKWY S", 50, 10650)
Gulf <- Fwy_interpolate(previous_match, unmatched, "GULF FWY", 550, 21750)
SouthFwy <- Fwy_interpolate(previous_match, unmatched, "SOUTH FWY", 2200, 13850)
SWFwy <- Fwy_interpolate(previous_match, unmatched, "SOUTHWEST FWY", 50, 14150)
Blackhawk <- Fwy_interpolate(previous_match, unmatched, "BLACKHAWK BLVD", 8450, 9850)
WestheimPkwy <- Fwy_interpolate(previous_match, unmatched, "WESTHEIMER PKWY", 15050, 25850)
WOrem <- Fwy_interpolate(previous_match, unmatched, "W OREM DR", 1250, 8050)
WLoopS <- Fwy_interpolate(previous_match, unmatched, "W LOOP S FWY", 150, 9550)
SLoopE <- Fwy_interpolate(previous_match, unmatched, "S LOOP E FWY", 150, 8850)
SLoopW <- Fwy_interpolate(previous_match, unmatched, "S LOOP W", 150, 8750)
ELoopN <- Fwy_interpolate(previous_match, unmatched, "E LOOP N FWY", 150, 3350)
EastFwy <- Fwy_interpolate(previous_match, unmatched, "EAST FWY", 1150, 13650)
Kingwood <- Fwy_interpolate(previous_match, unmatched, "KINGWOOD DR", 150, 19750)
BarkClod <- Fwy_interpolate(previous_match, unmatched, "BARKER-CLODINE RD", 150, 19750)
WLakeHouPkwy <- Fwy_interpolate(previous_match, unmatched, "W LAKE HOUSTON PKWY", 50, 16750)
ScottSt <- Fwy_interpolate(previous_match, unmatched, "SCOTT ST", 10050, 13550)
NWayside <- Fwy_interpolate(previous_match, unmatched, "N WAYSIDE DR", 250, 11050)
EOrem <- Fwy_interpolate(previous_match, unmatched, "E OREM DR", 3950, 7650)
WBellAve <- Fwy_interpolate(previous_match, unmatched, "W BELLFORT AVE", 1550, 11750)

#generated <- bind_rows(katy, northfwy, eastex, NSamE, SSamE,
#                       ESamS, SSamW, WSamS, Gulf, SouthFwy,
#                       SWFwy, Blackhawk) 
generated <- bind_rows(generated, WBellAve) 
generated <- unique(generated)

#---------------------------------------
#   E LOOP FWY is special

ELoop <- tribble(
  ~match_address, ~lat, ~long,
  "100 E LOOP FWY , Houston , TX",  29.726086, -95.266590,
  "1000 E LOOP FWY , Houston , TX", 29.738317, -95.265317,
  "3200 E LOOP FWY , Houston , TX", 29.769695, -95.265270
) %>%
  mutate(addr=as.numeric(str_extract(match_address, "^[0-9]+"))) %>% 
  unique() %>% 
  arrange(addr) 
#   Create points to interpolate to
dftargets <- seq(150,3150,by=100)

# interpolate
newlat <- approx(ELoop$addr, ELoop$lat, dftargets)
newlon <- approx(ELoop$addr, ELoop$long, dftargets)

#   Create a new dataframe with all "addresses" in it
newELoop <- tibble(addr=newlat$x, lat=newlat$y, long=newlon$y) %>% 
  mutate(Address=paste0(as.character(addr-50),"-",
                        as.character(addr+49),
                        paste0(" ",toupper("E LOOP FWY"), " , Houston , TX"))) %>% 
  mutate(Beat=NA, n=0, geocode_status="generated", 
         match_address=paste0(as.character(addr)," ","E Loop Fwy", ", Houston, TX"),
         tract=NA, block=NA, status="success") %>% 
  select(Address:match_address,lat, long, tract, block, status)
#---------------------------------------

#generated <- bind_rows(generated, newELoop) 

saveRDS(generated, "~/Dropbox/CrimeStats/Generated_Coordinates.rds")

```



```{r fix stuff}

mask <- grepl("MT VERNON", unmatched$RawAddress)

unmatched[mask,]$newstreet <- "MT VERNON ST"
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, "9 V", "9 MT V")

#-------------------------------------

mask <- grepl("MEMORIAL DR", unmatched$Address)
mask2 <- as.numeric(unlist(str_split(unmatched$Address,"-", simplify=TRUE))[,1])<700
mask <- mask&mask2
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "MEMORIAL DR", "MEMORIAL CITY MALL DR")

#-------------------------------------

mask <- grepl("5F30", unmatched$Beat)
mask2 <- as.numeric(unlist(str_split(unmatched$Address,"-", simplify=TRUE))[,1])<11000
mask <- mask&mask2
mask3 <- grepl("NORTHWEST", unmatched$Address)
mask <- mask&mask2&mask3
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "NORTHWEST FWY", "NORTHWEST DR")

#-------------------------------------

mask1 <- grepl("google fail", unmatched$geocode_status)
mask2 <- !is.na(unmatched$block)
mask <- mask1&mask2
sum(mask)
unmatched[mask,]$geocode_status  <- "census"

#-------------------------------------

mask <- grepl("24C30", unmatched$Beat)
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "9 MAIN ST", "9 S MAIN ST")

#-------------------------------------
#-------------------------------------

mask <- grepl("15E40", unmatched$Beat)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "S LOOP E FWY", "S LOOP W FWY")

#-------------------------------------

mask <- grepl("7900-7999 EAST SAM HOUSTON PKWY S", unmatched$Address)

unmatched[mask,]$lat <- 29.607578
unmatched[mask,]$long <- -95.204026
unmatched[mask,]$status    <- "success"
unmatched[mask,]$geocode_status    <- "google"

#-------------------------------------

mask <- grepl("@", unmatched$Address)
sum(mask)

unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address, 
                                        "@ .*$", "")
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
#-------------------------------------

mask <- grepl(" WEST RD", unmatched$match_address)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"

#-------------------------------------
#   Bus station is key to fixing address
mask <- grepl(" PRESSLER ", unmatched$Address) 
sum(mask)

unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address, "900-999", "1900-1999")
unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address, "1000-1099", "1900-1999")


#-------------------------------------

mask <- grepl(" MCCARTY ", unmatched$Address) &
        grepl(" MARKET ", unmatched$RawAddress)

unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address, "MCCARTY", "MARKET")


#-------------------------------------

mask <- grepl(" SH 6 ", unmatched$RawAddress)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, "SAM HOUSTON PKWY W", "SH 6")

#-------------------------------------

mask <- grepl(" SH 6 ", unmatched$RawAddress)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, "SAM HOUSTON PKWY W", "SH 6")

#-------------------------------------

mask <- grepl(" S LOOP E ", unmatched$Address) 
mask2 <- as.numeric(unlist(str_split(unmatched$Address,"-", simplify=TRUE))[,1])>8650
mask <- mask&mask2

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, " S LOOP E ", " SOUTH ")

#-------------------------------------

mask <- grepl(" EAST ST ", unmatched$Address)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, " EAST ST ", " EAST FWY ")

#-------------------------------------
  mask1 <- grepl("SOUTH FWY", unmatched$Address, ignore.case = TRUE)
  mask2 <- grepl("FWY BLVD", unmatched$RawAddress, ignore.case = TRUE)
  mask2[is.na(mask2)] <- FALSE
  mask <- mask1&mask2 
  print(sum(mask))
  unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address,
                                           "SOUTH FWY",
                                           "SOUTH BLVD")

#-------------------------------------
  mask1 <- grepl("W SAM HOUSTON PKWY S", unmatched$match_address, ignore.case = TRUE)
  mask2 <- as.numeric(str_extract(unmatched$match_address, "\\d+"))>10699
  mask2[is.na(mask2)] <- FALSE
  mask <- mask1&mask2 
  print(sum(mask))
  unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address,
                                           "W SAM HOUSTON PKWY S",
                                           "S SAM HOUSTON PKWY W")

#-------------------------------------

mask <- grepl(" PARK @ FAIRDALE ", unmatched$RawAddress)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, "PARK ", "PARK AT FAIRDALE")

mask <- grepl(" PARK @ BEVERLY HILL ", unmatched$RawAddress)

unmatched[mask,]$lat <- NA
unmatched[mask,]$long <- NA
unmatched[mask,]$status    <- "Names mismatch"
unmatched[mask,]$geocode_status    <- "google fail"
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, "PARK ", "PARK AT BEVERLY HILLS")

#------------------------------------------
#Bad address match()
unmatched %>% 
  filter(status=="success") %>% 
  mutate(inaddress=as.numeric(str_extract(Address, "^[0-9]+"))) %>% 
  mutate(utaddress=as.numeric(str_extract(match_address, "^[0-9]+"))) %>% 
  filter(inaddress-utaddress>100) %>% 
  head()

unmatched2 <- unmatched

for (i in 1:nrow(unmatched)) {
  if(unmatched[i,]$status=="success" &
    ((as.numeric(str_extract(unmatched[i,]$Address, "^[0-9]+")) - 
     as.numeric(str_extract(unmatched[i,]$match_address, "^[0-9]+")))>100)) {
        print(paste("-----", i))
        unmatched[i,]$lat <- NA
        unmatched[i,]$long <- NA
        unmatched[i,]$status    <- "Names mismatch"
        unmatched[i,]$geocode_status    <- "google fail"
    
     }
}


```

