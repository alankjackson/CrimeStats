---
title: "Geocoding"
output: html_document
---

```{r setup, include=FALSE}

library(ggmap)
library(stringr)
library(tidyr)
library(dplyr)
library(purrr)

# Long/Lat (lowerleft) Long/Lat (upper right)
HoustonBoundary <- c(-95.789963, 29.518566, -95.005814, 30.117875)
gmap = get_map(location=c(-95.4142, 29.7907), source="google",zoom=12)

googleproj4 <- "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"
googlecrs <- "4326"

testgeocode <- function(x){
              if(length(x$results)==0){
                print(paste("--->", x$status))
              }
}

knitr::opts_chunk$set(echo = TRUE)
```

Build a new data frame with only addresses, delete incomplete records, and
join with last GeoTable so we don't go off and repeat work that has already
been done.


```{r Build a clean input for google geocode, eval=FALSE}
# then clear up to only unique values and split each record in two, one for each
# end of the block. Output will be a datafile of keys and addresses.

df = readRDS("~/Dropbox/CrimeStats/District4fCleanData.rds")
geotable <- readRDS("~/Dropbox/CrimeStats/GeoTable.rds")

#   Build a new dataframe with addresses in it
workingset <- data.frame(paste(df$Block_Range,df$Street,", Houston, TX"), stringsAsFactors = FALSE)
colnames(workingset)[1] = "Address"

workingset$Block_Range <- df$Block_Range

workingset <- unique(workingset) # filter down to unique addresses
#   kill off NA's
workingset <- as.data.frame(workingset[!grepl("9 NA ,|UNK NA", workingset$Address),])

# split out beginning and ending block addresses and street name
workingset[,3] = str_extract(workingset$Address,"^\\d+")
workingset[,4] = str_extract(workingset$Address,"\\d+ ")
workingset[,5] = str_extract(workingset$Address," .+$")
colnames(workingset)[3] = "Add1"
colnames(workingset)[4] = "Add2"
colnames(workingset)[5] = "Street"

# delete records that are incomplete
workingset <- workingset[complete.cases(workingset),]

# match with geotable to use lat long values that are already known
workingset <- left_join(workingset, geotable, by="Address")
workingset <- select(workingset, Address, Add1, Add2, Street.x, Longitude, Latitude)
colnames(workingset)[4]="Street"

```

Actually go get the lat long values from Google, 2400 per day.
When done, redo for those that were skipped or failed, and redo
some that are wierd - sometimes second time works.
Delete any coordinates that land outside the city box, do some 
cleanup, average the block range values, unless there is only
on lat/long set, in which case use it.
Finally save the new GeoTable.


```{r get lat longs from google, eval=FALSE}

#   Empty dataframe for accepting lat long values
latlongs <- data.frame(types=character(),
                 Latitude=numeric(), 
                 Longitude=numeric(), 
                 type=character(),
                 StreetName=character(),
                 LocType=character(),
                 stringsAsFactors=FALSE) 

#   Function for pulling fields out of nested lists returned by geocode
getfields <- function(x){
              if(length(x$results)>0)  {data.frame(
              Latitude=as.numeric(x$results[[1]]$geometry$location["lat"]),
              Longitude=as.numeric(x$results[[1]]$geometry$location["lng"]),
              types=x$results[[1]]["types"][1],
              StreetName=x$results[[1]]$formatted_address,
              LocType=x$results[[1]]$geometry$location_type,
              stringsAsFactors = FALSE)
              } else if (exists("x$status") && x["status"]=="ZERO_RESULTS"){
                data.frame(types="ZERO_RESULTS",Latitude=NA,Longitude=NA, StreetName=NA,LocType=NA,stringsAsFactors = FALSE)
              } else{
                data.frame(types=NA,Latitude=NA,Longitude=NA, StreetName=NA,LocType=NA,stringsAsFactors = FALSE)
              }
}

# run geocode for each record up to the daily limit, and then average the lat/long
# values from each end of the block to get a true block center value.

Addresses <- paste(workingset$Add1[1:2400], workingset$Street[1:2400])
AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields


#   initialize workingset first time through with new columns
workingset$lon1 <- NA
workingset$lat1 <- NA
workingset$lon2 <- NA
workingset$lat2 <- NA
workingset$type <- NA
workingset$StreetName <- NA
workingset$LocType <- NA
workingset$type2 <- NA
workingset$StreetName2 <- NA
workingset$LocType2 <- NA

workingset$lon1[1:1603] = latlongs$Longitude[1:1603]
workingset$lat1[1:1603] = latlongs$Latitude[1:1603]
workingset$type[1:1603] = latlongs$types[1:1603]
workingset$StreetName[1:1603] = latlongs$StreetName[1:1603]
workingset$LocType[1:1603] = latlongs$LocType[1:1603]

```

Second pass to catch more lat longs
***********   23 Feb 8:45 PM skip to lat2 section

```{r get more lat longs from google}

geocodeQueryCheck()
Addresses <- paste(workingset$Add1[2401:4800], workingset$Street[2401:4800])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[2401:4800] = latlongs$Longitude
workingset$lat1[2401:4800] = latlongs$Latitude
workingset$type[2401:4800] = latlongs$types
workingset$StreetName[2401:4800] = latlongs$StreetName
workingset$LocType[2401:4800] = latlongs$LocType

```

Third pass on Add1

```{r get more lat longs from google}
##### Run on 14th after 9:30PM 
Addresses <- paste(workingset$Add1[4801:5240], workingset$Street[4801:5240])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[4801:5240] = latlongs$Longitude
workingset$lat1[4801:5240] = latlongs$Latitude
workingset$type[4801:5240] = latlongs$types
workingset$StreetName[4801:5240] = latlongs$StreetName
workingset$LocType[4801:5240] = latlongs$LocType
```


First pass on Addr2

```{r get more lat longs from google}

##### Run on 23rd after 8:45PM
geocodeQueryCheck()

Addresses <- paste(workingset$Add2[1:1603], workingset$Street[1:1603])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[1:1603] = latlongs$Longitude
workingset$lat2[1:1603] = latlongs$Latitude
workingset$type2[1:1603] = latlongs$types
workingset$StreetName2[1:1603] = latlongs$StreetName
workingset$LocType2[1:1603] = latlongs$LocType

```

Second pass on Add2

```{r get more lat longs from google}
##### Run on 16th after 9PM
geocodeQueryCheck()

Addresses <- paste(workingset$Add2[2401:4800], workingset$Street[2401:4800])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[2401:4800] = latlongs$Longitude
workingset$lat2[2401:4800] = latlongs$Latitude
workingset$type2[2401:4800] = latlongs$types
workingset$StreetName2[2401:4800] = latlongs$StreetName
workingset$LocType2[2401:4800] = latlongs$LocType

```

Third pass on Add2

```{r get more lat longs from google}
##### Run on 17th after 9:30PM
geocodeQueryCheck()
Addresses <- paste(workingset$Add2[4801:5240], workingset$Street[4801:5240])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[4801:5240] = latlongs$Longitude
workingset$lat2[4801:5240] = latlongs$Latitude
workingset$type2[4801:5240] = latlongs$types
workingset$StreetName2[4801:5240] = latlongs$StreetName
workingset$LocType2[4801:5240] = latlongs$LocType

```



```{r get more lat longs from google}
#############################################
##### Cleanup the ones that got skipped
#############################################
geocodeQueryCheck()
###  rerun if lon1 and Longitude are NA, but not if ZERO_RESULTS
mask1 <- is.na(workingset$lon1)&is.na(workingset$Longitude)& !(workingset$type == "ZERO_RESULTS" & !is.na(workingset$type))
#   how many more to try?
sum(mask1)

Addresses <- paste(workingset$Add1[mask1], workingset$Street[mask1])

AllLatLong <- geocode(Addresses, output="all") # geocode addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[mask1] = latlongs$Longitude
workingset$lat1[mask1] = latlongs$Latitude
workingset$type[mask1] = latlongs$types
workingset$StreetName[mask1] = latlongs$StreetName
workingset$LocType[mask1] = latlongs$LocType

map_df(AllLatLong, testgeocode)

##################  lather, rinse, repeat

geocodeQueryCheck()

mask2 <- is.na(workingset$lon2)&is.na(workingset$Longitude)& !(workingset$type2 == "ZERO_RESULTS" & !is.na(workingset$type2))
sum(mask2)
Addresses <- paste(workingset$Add2[mask2], workingset$Street[mask2])

AllLatLong <- geocode(Addresses, output="all") # geocode addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[mask2] = latlongs$Longitude
workingset$lat2[mask2] = latlongs$Latitude
workingset$type2[mask2] = latlongs$types
workingset$StreetName2[mask2] = latlongs$StreetName
workingset$LocType2[mask2] = latlongs$LocType
sum(is.na(workingset$lat1)&is.na(workingset$Latitude))
sum(is.na(workingset$lon1)&is.na(workingset$Longitude))
sum(is.na(workingset$lat2)&is.na(workingset$Latitude))
sum(is.na(workingset$lon2)&is.na(workingset$Longitude))

map_df(AllLatLong, testgeocode)
##################  lather, rinse, repeat

#   set any coordinate outside the box to NA

outside <- workingset$lon1<HoustonBoundary[1] | workingset$lon1>HoustonBoundary[3] | is.na(workingset$lon1)
workingset$lon1[outside] <- NA

outside <- workingset$lon2<HoustonBoundary[1] | workingset$lon2>HoustonBoundary[3] | is.na(workingset$lon2)
workingset$lon2[outside] <- NA

outside <- workingset$lat1<HoustonBoundary[2] | workingset$lat1>HoustonBoundary[4] | is.na(workingset$lat1)
workingset$lat1[outside] <- NA

outside <- workingset$lat2<HoustonBoundary[2] | workingset$lat2>HoustonBoundary[4] | is.na(workingset$lat2)
workingset$lat2[outside] <- NA
  
#   Check input street names against output

getstreet <- function(x){
  a <- str_replace(strsplit(x[4]," ,")[[1]][1],"\\d* ","") # get everything before ","
  a[[1]][length(a[[1]])] # take last item in that field
}
#   Pull out names given to google
a <- as.data.frame(apply(workingset,1,getstreet))
names(a) <- "Street"

#  Compare names with names google supplied 
problemchildren <- data.frame(child=character(), stringsAsFactors = FALSE)
for (i in 1:length(a$Street)){
  if (!grepl(a$Street[i], workingset$StreetName[i], ignore.case = TRUE)&!is.na(workingset$StreetName[i])) {
    tempdf <- data.frame(child=paste(i,a$Street[i], workingset$StreetName[i], sep=" : ") )
    problemchildren <- rbind(problemchildren, tempdf)
  }
}

#   null out lat/lon where streets don't match

NullOut <- c(50, 307, 360, 462, 466, 907, 1235, 1286, 1367, 1473, 1498, 1758, 1836, 1879, 1956, 2022, 2096, 2328, 2365, 2451, 2614, 2672, 2679, 2706, 2765, 2786, 2800, 2911, 2931, 2967, 2989, 3126, 3145, 3346, 3375, 3399, 3536, 3640, 3737, 3826, 3908, 3923, 3939, 4050, 4154, 4213, 4243, 4297, 4328, 4356, 4364, 4365, 4370, 4420, 4422, 4424, 4455, 4479, 4497, 4498, 4509, 4513, 4514, 4551, 4566, 4605, 4606, 4615, 4648, 4559, 4678, 4680, 4684, 4696, 4750, 4753, 4779, 4812, 4860, 4879, 4881, 4888, 4891, 4928, 4946, 4951, 4961, 4966, 4968, 4984, 4988, 4995, 4997, 5003, 5011, 5015, 5023, 5049, 5073, 5102, 5114, 5147, 5192, 5218, 5232)

for (i in NullOut) {workingset$lat1[i] <- NA
                    workingset$lon1[i] <- NA
                    }

#  Compare names with names google supplied 
problemchildren <- data.frame(child=character(), stringsAsFactors = FALSE)
for (i in 1:length(a$Street)){
  if (!grepl(a$Street[i], workingset$StreetName2[i], ignore.case = TRUE)&!is.na(workingset$StreetName[i])) {
    tempdf <- data.frame(child=paste(i,a$Street[i], workingset$StreetName2[i], sep=" : ") )
    problemchildren <- rbind(problemchildren, tempdf)
  }
}
NullOut <- c(1367, 1473, 1702, 1956, 2022, 2274, 2328, 2589, 2706, 2765, 2786, 2800, 2911, 2967, 3126, 3145, 3399, 3427, 3440, 3766, 3783, 3908, 3955, 3986, 4214, 4235, 4292, 4296, 4297, 4299, 4328, 4356, 4360, 4364, 4365, 4370, 4389, 4420, 4424, 4452, 4462, 4464, 4475, 4479, 4497, 4498, 4509, 4546, 4551, 4568, 4605, 4606, 4614, 4615, 4619, 4659, 4670, 4673, 4678, 4679, 4684, 4888, 4891, 4928, 4953, 4961, 4962, 4966, 4968, 4984, 4994, 4995, 4997, 5003, 5004, 5011, 5023, 5030, 5049, 5073, 5102, 5121, 5147, 5176, 5218, 5231, 5232
)
for (i in NullOut) {workingset$lat1[i] <- NA
                    workingset$lon1[i] <- NA
                    }

###   some lat/longs are bogus. Find them 
#   If the distance between latlong1 and 2 > 5x the median, flag
distance <- sqrt((workingset$lat2- workingset$lat1)**2 + (workingset$lon2- workingset$lon1)**2)* 69 # approximately in miles
distance <- as.data.frame(distance)
distance[is.na(distance)] <- 0
meddist <- 5*median(distance$distance, na.rm = TRUE)
filter(distance, distance>0.01&distance<5*meddist) %>%
 ggplot() +
 geom_histogram(aes(x=distance),binwidth = 0.01) +
  xlab("miles")

bogus <- distance>meddist

problemchildren <- workingset[bogus,]

#   null out bogus lat lons

workingset$lat1[bogus] <- NA
workingset$lon1[bogus] <- NA
workingset$lat2[bogus] <- NA
workingset$lon2[bogus] <- NA
#   Average lats and longs to get block center coordinates

keepworking = workingset
workingset$Longitude <- rowMeans(subset(workingset, select=c(lon1, lon2)), na.rm = TRUE) 
workingset$Latitude <- rowMeans(subset(workingset, select=c(lat1, lat2)), na.rm = TRUE) 

getblk <- function(x){return(strsplit(x["Address"]," ", fixed = TRUE)[[1]][1])}
blks <- as.data.frame(apply(workingset,1,getblk), stringsAsFactors = FALSE)
colnames(blks) <- "Block_Range"
workingset <- cbind(workingset, blks, stringsAsFactors=FALSE)

newGeotable <- workingset %>% select(Address, Street, Block_Range, Longitude, Latitude, StreetName)
names(newGeotable) <- c("Address", "Street", "Block_Range","Longitude", "Latitude", "GoogleName")

#   Append to old geotable
newGeotable <- bind_rows(geotable, newGeotable)

#   Save
saveRDS(newGeotable, "~/Dropbox/CrimeStats/GeoTable.rds")

```



