---
title: "Geocoding"
output: html_document
---

```{r setup, include=FALSE}

library(ggmap)
library(stringr)
library(tidyr)
library(dplyr)
library(purrr)

# Long/Lat (lowerleft) Long/Lat (upper right)
HoustonBoundary <- c(-95.789963, 29.518566, -95.005814, 30.117875)
gmap = get_map(location=c(-95.4142, 29.7907), source="google",zoom=12)

googleproj4 <- "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"
googlecrs <- "4326"

testgeocode <- function(x){
              if(length(x$results)==0){
                print(paste("--->", x$status))
              }
}

knitr::opts_chunk$set(echo = TRUE)
```

Build a new data frame with only addresses, delete incomplete records, and
join with last GeoTable so we don't go off and repeat work that has already
been done.


```{r Build a clean input for google geocode, eval=FALSE}
# then clear up to only unique values and split each record in two, one for each
# end of the block. Output will be a datafile of keys and addresses.

df = readRDS("~/Dropbox/CrimeStats/District1aCleanData.rds")
geotable <- readRDS("~/Dropbox/CrimeStats/GeoTable.rds")

#   Build a new dataframe with addresses in it
workingset <- data.frame(paste(df$Block_Range,df$Street,", Houston, TX"), stringsAsFactors = FALSE)
colnames(workingset)[1] = "Address"

workingset$Block_Range <- df$Block_Range

workingset <- unique(workingset) # filter down to unique addresses
#   kill off NA's
workingset <- as.data.frame(workingset[!grepl("9 NA ,|UNK NA", workingset$Address),])

# split out beginning and ending block addresses and street name
workingset[,3] = str_extract(workingset$Address,"^\\d+")
workingset[,4] = str_extract(workingset$Address,"\\d+ ")
workingset[,5] = str_extract(workingset$Address," .+$")
colnames(workingset)[3] = "Add1"
colnames(workingset)[4] = "Add2"
colnames(workingset)[5] = "Street"

# delete records that are incomplete
workingset <- workingset[complete.cases(workingset),]

# match with geotable to use lat long values that are already known
workingset <- left_join(workingset, geotable, by="Address")
workingset <- select(workingset,Address, Add1, Add2, Street.x, Longitude, Latitude)
colnames(workingset)[4]="Street"

```

Actually go get the lat long values from Google, 2400 per day.
When done, redo for those that were skipped or failed, and redo
some that are wierd - sometimes second time works.
Delete any coordinates that land outside the city box, do some 
cleanup, average the block range values, unless there is only
on lat/long set, in which case use it.
Finally save the new GeoTable.


```{r get lat longs from google, eval=FALSE}

#   Empty dataframe for accepting lat long values
latlongs <- data.frame(types=character(),
                 Latitude=numeric(), 
                 Longitude=numeric(), 
                 StreetName=character(),
                 stringsAsFactors=FALSE) 

#   Function for pulling fields out of nested lists returned by geocode
getfields <- function(x){
              if(length(x$results)>0)  {data.frame(
              types=x$results[[1]]$types[1],
              Latitude=as.numeric(x$results[[1]]$geometry$location$lat),
              Longitude=as.numeric(x$results[[1]]$geometry$location$lng),
              StreetName=x$results[[1]]$formatted_address,
              stringsAsFactors = FALSE)
              } else if (x$status=="ZERO_RESULTS"){
                data.frame(types="ZERO_RESULTS",Latitude=NA,Longitude=NA, StreetName=NA,stringsAsFactors = FALSE)
              } else{
                data.frame(types=NA,Latitude=NA,Longitude=NA, StreetName=NA,stringsAsFactors = FALSE)
              }
}

# run geocode for each record up to the daily limit, and then average the lat/long
# values from each end of the block to get a true block center value.

Addresses <- paste(workingset$Add1[1:2400], workingset$Street[1:2400])
AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields


#   initialize workingset first time through with new columns
workingset$lon1 <- NA
workingset$lat1 <- NA
workingset$lon2 <- NA
workingset$lat2 <- NA
workingset$type <- NA
workingset$StreetName <- NA
workingset$type2 <- NA
workingset$StreetName2 <- NA

workingset$lon1[1:2400] = latlongs$Longitude
workingset$lat1[1:2400] = latlongs$Latitude
workingset$type[1:2400] = latlongs$types
workingset$StreetName[1:2400] = latlongs$StreetName

```

Second pass to catch more lat longs

```{r get more lat longs from google}

##### Run on 13th after 9PM 
Addresses <- paste(workingset$Add1[2401:4800], workingset$Street[2401:4800])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[2401:4800] = latlongs$Longitude
workingset$lat1[2401:4800] = latlongs$Latitude
workingset$type[2401:4800] = latlongs$types
workingset$StreetName[2401:4800] = latlongs$StreetName

```

Third pass on Add1

```{r get more lat longs from google}
##### Run on 14th after 9:30PM 
Addresses <- paste(workingset$Add1[4801:5240], workingset$Street[4801:5240])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[4801:5240] = latlongs$Longitude
workingset$lat1[4801:5240] = latlongs$Latitude
workingset$type[4801:5240] = latlongs$types
workingset$StreetName[4801:5240] = latlongs$StreetName
```


First pass on Addr2

```{r get more lat longs from google}

##### Run on 15th after 9:30PM
geocodeQueryCheck()

Addresses <- paste(workingset$Add2[1:2400], workingset$Street[1:2400])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[1:2400] = latlongs$Longitude
workingset$lat2[1:2400] = latlongs$Latitude
workingset$type2[1:2400] = latlongs$types
workingset$StreetName2[1:2400] = latlongs$StreetName

```

Second pass on Add2

```{r get more lat longs from google}
##### Run on 16th after 9PM
geocodeQueryCheck()

Addresses <- paste(workingset$Add2[2401:4800], workingset$Street[2401:4800])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[2401:4800] = latlongs$Longitude
workingset$lat2[2401:4800] = latlongs$Latitude
workingset$type2[2401:4800] = latlongs$types
workingset$StreetName2[2401:4800] = latlongs$StreetName

```

Third pass on Add2

```{r get more lat longs from google}
##### Run on 17th after 9:30PM
geocodeQueryCheck()
Addresses <- paste(workingset$Add2[4801:5240], workingset$Street[4801:5240])

AllLatLong <- geocode(Addresses, output="all") # geocode 2400 addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[4801:5240] = latlongs$Longitude
workingset$lat2[4801:5240] = latlongs$Latitude
workingset$type2[4801:5240] = latlongs$types
workingset$StreetName2[4801:5240] = latlongs$StreetName

```



```{r get more lat longs from google}
#############################################
##### Cleanup the ones that got skipped
#############################################
geocodeQueryCheck()
###  rerun if lon1 and Longitude are NA, but not if ZERO_RESULTS
mask1 <- is.na(workingset$lon1)&is.na(workingset$Longitude)& !(workingset$type == "ZERO_RESULTS" & !is.na(workingset$type))
#   how many more to try?
sum(mask1)

Addresses <- paste(workingset$Add1[mask1], workingset$Street[mask1])

AllLatLong <- geocode(Addresses, output="all") # geocode addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon1[mask1] = latlongs$Longitude
workingset$lat1[mask1] = latlongs$Latitude
workingset$type[mask1] = latlongs$types
workingset$StreetName[mask1] = latlongs$StreetName

map_df(AllLatLong, testgeocode)

##################  lather, rinse, repeat

geocodeQueryCheck()

mask2 <- is.na(workingset$lon2)&is.na(workingset$Longitude)& !(workingset$type2 == "ZERO_RESULTS" & !is.na(workingset$type2))
sum(mask2)
Addresses <- paste(workingset$Add2[mask2], workingset$Street[mask2])

AllLatLong <- geocode(Addresses, output="all") # geocode addresses

latlongs <- map_df(AllLatLong, getfields) # extract desired fields

workingset$lon2[mask2] = latlongs$Longitude
workingset$lat2[mask2] = latlongs$Latitude
workingset$type2[mask2] = latlongs$types
workingset$StreetName2[mask2] = latlongs$StreetName
sum(is.na(workingset$lat1)&is.na(workingset$Latitude))
sum(is.na(workingset$lon1)&is.na(workingset$Longitude))
sum(is.na(workingset$lat2)&is.na(workingset$Latitude))
sum(is.na(workingset$lon2)&is.na(workingset$Longitude))

map_df(AllLatLong, testgeocode)
##################  lather, rinse, repeat
######   stopped here
######   start here on Sunday after 9

###   some lat/longs are bogus. Find them and redo
#   If the distance between latlong1 and 2 > 5x the median, redo
distance <- abs(workingset$lat2- workingset$lat1) + abs(workingset$lon2- workingset$lon1)
distance <- as.data.frame(distance)
distance[is.na(distance)] <- 0
meddist <- 5*median(distance$distance, na.rm = TRUE)
filter(distance, distance>0.01&distance<5) %>%
 ggplot() +
 geom_histogram(aes(x=distance),binwidth = 0.01)

bogus <- distance>meddist
########   Wednesday start here
latlong1 = geocode(paste(workingset[bogus,]$Add1, workingset[bogus,]$Street))
workingset[bogus,]$lon1 - latlong1$lon
workingset[bogus,]$lat1 - latlong1$lat

workingset[bogus,]$lon1 = latlong1$lon
workingset[bogus,]$lat1 = latlong1$lat

latlong2 = geocode(paste(workingset[bogus,]$Add2, workingset[bogus,]$Street))

workingset[bogus,]$lon2 - latlong2$lon
workingset[bogus,]$lat2 - latlong2$lat

workingset[bogus,]$lon2 = latlong2$lon
workingset[bogus,]$lat2 = latlong2$lat

#   set any coordinate outside the box to NA

outside <- workingset$lon1<HoustonBoundary[1] | workingset$lon1>HoustonBoundary[3] | is.na(workingset$lon1)
workingset$lon1[outside] <- NA

outside <- workingset$lon2<HoustonBoundary[1] | workingset$lon2>HoustonBoundary[3] | is.na(workingset$lon2)
workingset$lon2[outside] <- NA

outside <- workingset$lat1<HoustonBoundary[2] | workingset$lat1>HoustonBoundary[4] | is.na(workingset$lat1)
workingset$lat1[outside] <- NA

outside <- workingset$lat2<HoustonBoundary[2] | workingset$lat2>HoustonBoundary[4] | is.na(workingset$lat2)
workingset$lat2[outside] <- NA

#   Average lats and longs to get block center coordinates

keepworking = workingset
workingset$avglon <- rowMeans(subset(workingset, select=c(lon1, lon2)), na.rm = TRUE) 
workingset$avglat <- rowMeans(subset(workingset, select=c(lat1, lat2)), na.rm = TRUE) 

newGeotable <- workingset %>% select(Address, Street, Block_Range, avglon, avglat)
names(newGeotable) <- c("Address", "Street", "Block_Range","Longitude", "Latitude")
saveRDS(newGeotable, "~/Dropbox/CrimeStats/GeoTable.rds")

```



