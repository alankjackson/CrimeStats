---
title: "Post Final Fix"
author: "Alan Jackson"
date: "April 24, 2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(dplyr)
library(ggmap)
library(lubridate)
library(sf)
library(nngeo)
library(units)

#unmatched <- readRDS( "~/Dropbox/CrimeStats/CensusGeoTable_progress.rds")

options(stringsAsFactors = FALSE)

apikey <- readRDS("~/Dropbox/CrimeStats/apikey.rds")
register_google(key = apikey)
googlecrs <- 4326

HoustonBdy <- c(-95.789963, 29.518566, -95.005814, 30.117875)
BoundBox <- "bounds=29.518566,-95.789963|30.117875,-95.005814"


knitr::opts_chunk$set(echo = TRUE)
```

##    Fix things looking at Beats intersecting with points turfed up


```{r fix it}

#  ----------  botched South Fwy

mask1 <- grepl("SOUTH FWY", unmatched$Address)
mask2 <- grepl(" DR ", unmatched$RawAddress)
mask <- mask1&mask2
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "SOUTH FWY", "SOUTH DR")

unmatched[mask,]$status  <- "redo"

mask1 <- grepl("SOUTH FWY", unmatched$Address)
mask2 <- grepl(" LOOP ", unmatched$RawAddress)
mask <- mask1&mask2
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "SOUTH FWY", "S LOOP E FWY")

unmatched[mask,]$status  <- "redo"

mask1 <- grepl("SOUTH FWY", unmatched$Address)
mask2 <- grepl(" CT ", unmatched$RawAddress)
mask <- mask1&mask2
sum(mask)
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address, 
                              "SOUTH FWY", "SOUTH CT")

unmatched[mask,]$status  <- "redo"

unmatched[mask1,]$status  <- "redo"

#  ----------  Census is just wrong, don't know why

mask1 <- grepl("HOLLISTER ST", unmatched$Address)
mask2 <- grepl(" DR,", unmatched$match_address)
mask <- mask1&mask2
sum(mask)

unmatched[mask,]$status  <- "redo"

#  ----------  Census is just wrong, don't know why

mask1 <- grepl("SOUTHWEST FWY", unmatched$Address)
mask2 <- grepl("1A50", unmatched$Beat)
mask3 <- grepl("77074", unmatched$match_address)
mask <- mask1&mask2&mask3
sum(mask)

unmatched[mask,]$status  <- "redo"

#  ----------  West airport, not airport

mask1 <- grepl("W AIRPORT", unmatched$Address)
mask2 <- grepl("16E20|16E30", unmatched$Beat)
mask <- mask1&mask2
sum(mask)

unmatched[mask,]$status  <- "redo"

#  ----------  N Sam in 13D40

mask1 <- grepl("N SAM HOUSTON PKWY E", unmatched$Address)
mask2 <- grepl("13D40", unmatched$Beat)
mask <- mask1&mask2
sum(mask)

unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "N SAM",
                                          "S SAM")

unmatched[mask,]$status  <- "redo"



#  ----------  airport, not west airport

mask1 <- grepl("W AIRPORT", unmatched$match_address, ignore.case = TRUE)
mask2 <- grepl("16E10|14D|13D", unmatched$Beat)
mask <- mask1&mask2
sum(mask)


unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "W AIRPORT",
                                          "AIRPORT")
unmatched[mask,]$status  <- "redo"


#  ----------  W Loop S

unmatched$Address <- str_replace(unmatched$Address, "W LOOP S ,", 
                                                    "W LOOP S FWY ,")
mask1 <- grepl("W LOOP S", unmatched$Address)
mask2 <- grepl("77056", unmatched$match_address)
mask3 <- grepl("77027", unmatched$match_address)
mask <- mask1&!mask2&!mask3
sum(mask)

unmatched[mask,]$status  <- "redo"

mask2 <- grepl("redo fail", unmatched$geocode_status )
mask <- mask1&mask2
sum(mask)
unmatched$Address <- str_replace(unmatched$Address, "W LOOP S FWY ,", 
                                                    "W LOOP S ,")

#  ----------  S Sam Houston Pkwy E

mask1 <- grepl("S SAM HOUSTON PKWY E", unmatched$Address)
sum(mask1)

unmatched[mask1,]$status  <- "redo"

#  ----------  S Sam Houston Pkwy W

mask1 <- grepl("S SAM HOUSTON PKWY W", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"

#  ----------  S Sam Houston Pkwy W convert to W Sam S

mask1 <- grepl("S SAM HOUSTON PKWY W", unmatched$Address)
sum(mask1)
mask2 <- grepl("17E30|19G50", unmatched$Beat)
mask3 <- grepl("19G50", unmatched$Beat)
mask <- mask1&mask2
sum(mask)

unmatched[mask,]$Address <- str_replace(unmatched[mask,]$Address, "S SAM HOUSTON PKWY W", 
                                                    "W SAM HOUSTON PKWT S")


#  ----------  South Fwy

mask1 <- grepl("SOUTH FWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  Katy Fwy

# First move points in Beat 2a10 TO EAST fWY

mask1 <- grepl("KATY FWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("2A10", unmatched$Beat)
sum(mask1&mask2)
mask <- mask1&mask2
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "KATY",
                                          "EAST")

#   now do the rest

mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  Southwest Fwy

mask1 <- grepl("SOUTHWEST FWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  Zero out all of S Loop W

mask1 <- grepl("S LOOP W", unmatched$Address)
sum(mask1)

unmatched[mask1,]$geocode_status  <- "redo"
unmatched[mask1,]$status  <- "redo"


#  ----------  North Fwy

mask1 <- grepl("NORTH FWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  W SAM S 

mask1 <- grepl("W SAM HOUSTON PKWY S", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  N SAM E 

mask1 <- grepl("N SAM HOUSTON PKWY E", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  S SAM E 

mask1 <- grepl("S SAM HOUSTON PKWY E", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"


#  ----------  East Fwy

mask1 <- grepl("EAST FWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  W Orem

mask1 <- grepl("W OREM DR", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  Kingwood Dr

mask1 <- grepl("KINGWOOD DR", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  W Lake Houston Pkwy

mask1 <- grepl("W LAKE HOUSTON PKWY", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"

#  ----------  N Wayside Dr

mask1 <- grepl("N WAYSIDE DR", unmatched$Address)
sum(mask1)
mask2 <- grepl("manual", unmatched$geocode_status)
sum(mask1&!mask2)

unmatched[mask1&!mask2,]$geocode_status  <- "redo"
unmatched[mask1&!mask2,]$status  <- "redo"



#  ----------  Broadway spot

mask1 <- grepl("8399 BROADWAY ", unmatched$Address)
sum(mask1)

unmatched[mask1,]$Address  <- str_replace(unmatched[mask1,]$Address,
                                          "BROADWAY ,",
                                          "BROADWAY ST ,")

unmatched[mask1,]$status  <- "redo"

#  ----------  Bay Area Blvd

mask1 <- grepl("BAY AREA BLVD ", unmatched$Address)
mask2 <- grepl(" W", unmatched$RawAddress)
mask3 <- grepl("12D70", unmatched$Beat)
mask <- mask1&(mask2|mask3)
sum(mask)

unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "9 BAY AREA BLVD ,",
                                          "8 W BAY AREA BLVD ,")
unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "WEST BAY AREA BLVD ,",
                                          "W BAY AREA BLVD ,")

unmatched[mask,]$status  <- "redo"

#  ----------  Most are not N Eldridge

mask1 <- grepl("N ELDRIDGE", unmatched$match_address, ignore.case = TRUE)
mask2 <- !grepl("20G60|4F30", unmatched$Beat)
mask <- mask1&mask2
sum(mask)


unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "N ELDRIDGE",
                                          "ELDRIDGE")
unmatched[mask,]$status  <- "redo"

#  ----------  Airport Blvd

mask1 <- grepl("W AIRPORT BLVD", unmatched$match_address, ignore.case = TRUE)
mask2 <- grepl("16E10|14D40|14D20|14D30|14D50|13D20|13D30", unmatched$Beat)
mask <- mask1&mask2
sum(mask)


unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "W AIRPORT",
                                          "AIRPORT")
unmatched[mask,]$status  <- "redo"

#  ----------  NORTH FWY BLVD

mask <- grepl("NORTH FWY BLVD", unmatched$RawAddress, ignore.case = TRUE)
sum(mask)

unmatched[mask,]$Address  <- str_replace(unmatched[mask,]$Address,
                                          "FWY",
                                          "BLVD")
unmatched[mask,]$status  <- "redo"

#  ----------  Some success have no lat long!

mask1 <- grepl("success", unmatched$status)
mask2 <- is.na(unmatched$lat)
mask <- mask1&mask2
sum(mask)

unmatched[mask,]$status  <- "fail"


```
##  redo special cases just in case

```{r special}
unmatched2 <- unmatched # just in case

###############   special case function
special_case <- function(mydf, mask, address, lat, long){
  if (sum(mask)>0){
    print(paste(sum(mask), "records changed"))
    mydf[mask,]$match_address <- address
    mydf[mask,]$status    <- "success"
    mydf[mask,]$geocode_status    <- "manual"
    mydf[mask,]$lat    <- lat
    mydf[mask,]$long   <- long
    mydf[mask,]$GType    <- "RANGE_INTERPOLATED manual"
  }
  return(mydf)
}
#################

#   Specific road spots

specific <- tribble(
  ~block, ~street, ~number, ~lat, ~long, ~zip,
  "900-999", "Skyline Vista", "930", 29.759302, -95.377399, "Houston, TX 77019",
  "0-99", "N SAN JACINTO ST", "30", 29.762918, -95.357548, "Houston, TX 77002",
  "1100-1199", "W OREM DR", "1250", 29.627650, -95.387823, "Houston, TX 77047",
  "8000-8099", "W OREM DR", "8050", 29.625046, -95.504899, "Houston, TX 77085",
  "1100-1199", "ENTRANCE", "6604 Arnot", 29.769932, -95.429635, "Houston, TX 77007",
  "200-299", "KATY FWY", "250", 29.777888, -95.372539, "Houston, TX 77007",
"2100-2199", "KATY FWY", "2150", 29.778031, -95.379982, "Houston, TX 77007",
"1900-1999", "KATY FWY", "1950", 29.779203, -95.375940, "Houston, TX 77007",
"2000-2099", "PRESSLER ST", "2050", 29.704626, -95.407318, "Houston, TX 77030",
"1400-1499", "PRESSLER ST", "1450", 29.704416, -95.396160, "Houston, TX 77030",
"26000-26099", "EASTEX FWY", "26050", 30.071838, -95.245656, "Porter, TX 77365", 
"3400-3499", "BARKER-CLODINE RD", "3425", 29.734172, -95.688014, "Houston, TX, 77094",
"14700-14799", "WOODSON PARK DR", "14700", 29.931124, -95.203876,"Houston, TX 77044",
"14600-14699", "VILLAGE EVERGREEN TRAIL", "14650", 29.576914, -95.151576, "Houston, TX 77062",
"14700-14799", "VILLAGE EVERGREEN TRAIL", "14750", 29.575495, -95.150133, "Houston, TX 77062",
"14800-14899", "VILLAGE EVERGREEN TRAIL", "14850", 29.574021, -95.149039, "Houston, TX 77062",
"4300-4399", "WOODLAND HILLS DR", "4350", 30.075192, -95.213783, "Kingwood, TX 77339",
"2800-2899", "VICTORY DR", "2801", 29.870550, -95.452790, "Houston, TX 77088",
"2400-2499", "WALKER ST", "2400", 29.750399, -95.352220, "Houston, TX 77003",
"18400-18499", "GATEBROOK DR", "18400", 29.555526, -95.150419, "Webster, TX 77598",
"18300-18399", "GATEBROOK DR", "18350", 29.555826, -95.150728, "Webster, TX 77598",
"10700-10799", "ELLA BLVD", "10755", 29.939246, -95.432656, "Houston, TX 77067",
"7800-7899", "MORLEY ST", "7850", 29.661369, -95.277006, "Houston, TX 77061",
"4400-4499", "NORTHPARK DR", "4450", 30.070439, -95.181017, "Kingwood, TX 77345",
"2200-2299", "SOUTH FWY", "2250", 29.742508, -95.364159, "Houston, TX 77003",
"4800-4899", "GLORY LAND", "4850", 29.677277, -95.351772, "Houston, TX 77033",
"4900-4999", "GLORY LAND", "4950", 29.676764, -95.350023, "Houston, TX 77033",
"7000-7099", "NORTHWEST DR", "7050", 29.847370, -95.496132, "Houston, TX 77092",
"7200-7299", "NORTHWEST DR", "7250", 29.849742, -95.499234, "Houston, TX 77092",
"14100-14199", "SPACE CENTER BLVD", "14150", 29.591602, -95.137589, "Houston, TX 77062",
"9700-9799", "CLEARWOOD DR", "9750", 29.627978, -95.248547, "Houston, TX 77075",
"5500-5599", "TIDWELL ESTATES LANE", "5550", 29.846497, -95.432640, "Houston, TX 77091",
"1600-1699", "ZOO CIRCLE DR", "1650", 29.715758, -95.389866, "Houston, TX 77030",
"3700-3799", "SOUTHWEST FWY", "3797", 29.728644, -95.437044, "Houston, TX 77027",
"100-199", "GULF FWY", "150", 29.761877, -95.372678, "Houston, TX 77002",
"200-299", "GULF FWY", "250", 29.761063, -95.373299, "Houston, TX 77002",
"300-399", "GULF FWY", "350", 29.759926, -95.373776, "Houston, TX 77002",
"3600-3699", "W BELLFORT AVE", "3650", 29.672850, -95.435746, "Houston, TX 77025",
"1500-1599", "W BELLFORT AVE", "1550", 29.673346, -95.399771, "Houston, TX 77054",
"9500-9599", "ROWLETT RD", "9550", 29.631819, -95.234351, "Houston, TX 77075",
"2400-2499", "SAWYER HEIGHTS ST", "2450", 29.775153, -95.384886, "Houston, TX 77007",
"5600-5699", "S LAKE HOUSTON PKWY", "5650", 29.813299, -95.210692, "Houston, TX 77049",
"00-99", "W LAKE HOUSTON PKWY", "50", 30.092091, -95.191164, "Porter, TX 77365",
"5700-5799", "DEEP FOREST DR", "5750",  29.850715, -95.477162, "Houston, TX 77092",
"10400-10499", "CLUB CREEK DR", "10400", 29.689646, -95.553926, "Houston, TX 77036",
"3800-3899", "N MCCARTY ST", "3850", 29.795996, -95.272480, "Houston, TX 77029",
"0-99", "EL DORADO BLVD", "50", 29.554233, -95.152973, "Webster, TX 77598",
"13000-13099", "S MAIN ST", "13000", 29.643500, -95.473750, "Houston, TX 77085",
"0-99", "HOBBY AIRPORT LOOP", "50", 29.654723, -95.276696, "Houston, TX 77061",
"13800-13899", "BLUERIDGE RD", "13850", 29.625651, -95.492953, "Houston, TX 77085",
"5400-5499", "WHITLEY ST", "5400", 29.717909, -95.410526, "Houston, TX 77005",
"3200-3299", "E LOOP N FWY", "3299", 29.769509, -95.265411, "Houston, TX 77029",
"0-99", "W EL DORADO BLVD", "50", 29.552748, -95.154955, "Friendswood, TX 77546",
"800-899", "WOODLAND HILLS DR", "800", 30.027739, -95.209054, "Kingwood, TX 77339",
"1400-1499", "WOODLAND HILLS DR", "1450", 30.031889, -95.216047, "Kingwood, TX 77339",
"900-999", "PACIFIC ST", "950", 29.746687, -95.390529, "Houston, TX 77006",
"12200-12299", "KUYKENDAHL RD", "12250", 29.961347, -95.421399, "Houston, TX 77060",
"10800-10899", "FUQUA ST", "10800", 29.611496, -95.225305, "Houston, TX 77089",
"1800-1899", "BARKER-CLODINE RD", "1850", 29.773785, -95.685505, "Houston, TX 77094",
"3500-3599", "BARKER-CLODINE RD", "3550", 29.734850, -95.687270, "Houston, TX 77082",
"15400-15499", "DIPLOMATIC PLAZA DR", "15450", 29.940739, -95.321507, "Houston, TX 77032",
"15500-15599", "DIPLOMATIC PLAZA DR", "15550", 29.942524, -95.321534, "Houston, TX 77032",
"7600-7699", "E OREM DR", "7690", 29.625445, -95.285922, "Houston, TX 77075",
"3900-3999", "E OREM DR", "3990", 29.628765, -95.364568, "Houston, TX 77047"
)

for (i in 1:nrow(specific)) {
  mask <- grepl(paste(specific[i,]$block, specific[i,]$street), 
                unmatched$Address, ignore.case=TRUE)
  print(paste(specific[i,]$street, sum(mask)))
  unmatched <- special_case(unmatched, 
                   mask, 
                   paste0(specific[i,]$number, " ", 
                          specific[i,]$street, ", ",
                          specific[i,]$zip),
                  specific[i,]$lat, 
                  specific[i,]$long 
                   )
}

```


##  Redo google geocoding to see what we can recover easily

But later, check these. Set geocode_status to "google redo" if
successful, "redo fail" if not

```{r google redo}

#===============================
#   check for previous match
#===============================
check_match <- function(test_Address, testdata){
    # Did I already succeed at this match somewhere?
    a <- testdata %>% filter(test_Address == Address,
                              status=="success" )
    if (nrow(a)>0){
      return(a)
    } else {return(FALSE)}
}

```

##  Create a KML file

```{r kml}

make_kml <- function(df, output) {
  
  #   write out headers
  
  write(c('<?xml version="1.0" encoding="UTF-8"?>',
               '<kml xmlns="http://earth.google.com/kml/2.0">',
               '<Document>'), output)
  
  #   write out values
  
  newdf <- df %>% 
  mutate(name=paste0("<name>",str_extract(Address,"[0-9A-Z -]*"),"</name>")) %>% 
  mutate(label=paste0("<description>", as.character(row_number()), "</description>")) %>%
  mutate(coord=paste0("<Point><coordinates>",long,",",lat,",0</coordinates></Point>"))
  
  for (i in 1:nrow(newdf)) {
    write_lines("<Placemark>", output, append=TRUE)
    write_lines(newdf$name[i], output, append=TRUE)
    write_lines(newdf$label[i], output, append=TRUE)
    write_lines(newdf$coord[i], output, append=TRUE)
    write_lines("</Placemark>", output, append=TRUE)
  }
  
  #   write out trailer
  
  write_lines(c( "</Document>", "</kml>"), output, append=TRUE)
}

```

##    Interpolate

```{r interpolate fwy}

Fwy_interpolate <- function(unmatched, match_str, start, stop) {
  #   create dataframe of good lat long to interpolate with 
  dfstart <- unmatched %>% 
    filter(status=="success" && geocode_status != "generated") %>% 
    filter(grepl(tolower(match_str), tolower(Address)))  %>% 
    select(Address, lat, long) %>%
    mutate(addr=as.numeric(str_extract(Address, "^[0-9]+"))) %>% 
    unique() %>% 
    arrange(addr) 
    
  #   Create points to interpolate to
  dftargets <- seq(start,stop,by=100)
  
  # interpolate
  newlat <- approx(dfstart$addr, dfstart$lat, dftargets)
  newlon <- approx(dfstart$addr, dfstart$long, dftargets)
  
  #   Create a new dataframe with all "addresses" in it
  generated <- tibble(addr=newlat$x, lat=newlat$y, long=newlon$y) %>% 
    mutate(Address=paste0(as.character(addr-50),"-",
                          as.character(addr+49),
                          paste0(" ",toupper(match_str), " , Houston , TX"))) %>% 
    mutate(Beat=NA, n=0, geocode_status="generated", 
           #Address=paste0(as.character(addr)," ",match_str, ", Houston, TX"),
           tract=NA, block=NA, status="success") %>% 
    select(Address,lat, long, tract, block, status)
  return(generated)
}


katy <- Fwy_interpolate(unmatched, "Katy Fwy", 1650, 21850)
northfwy <- Fwy_interpolate(unmatched, "North Fwy", 950, 17050)
eastex <- Fwy_interpolate(unmatched, "Eastex Fwy", 850, 25950)
NSamE <- Fwy_interpolate(unmatched, "N SAM HOUSTON PKWY E", 150, 9750)
SSamE <- Fwy_interpolate(unmatched, "S SAM HOUSTON PKWY E", 3650, 12350)
ESamS <- Fwy_interpolate(unmatched, "EAST SAM HOUSTON PKWY S", 5550, 7850)
SSamW <- Fwy_interpolate(unmatched, "S SAM HOUSTON PKWY W", 3050, 12350)
WSamS <- Fwy_interpolate(unmatched, "W SAM HOUSTON PKWY S", 150, 10450)
Gulf <- Fwy_interpolate(unmatched, "GULF FWY", 450, 21650)
SouthFwy <- Fwy_interpolate(unmatched, "SOUTH FWY", 2350, 13350)
SWFwy <- Fwy_interpolate(unmatched, "SOUTHWEST FWY", 450, 11650)
Blackhawk <- Fwy_interpolate(unmatched, "BLACKHAWK BLVD", 8550, 9750)
WestheimPkwy <- Fwy_interpolate(unmatched, "WESTHEIMER PKWY", 15150, 20050)
WOrem <- Fwy_interpolate(unmatched, "W OREM DR", 1250, 7950)
WLoopS <- Fwy_interpolate(unmatched, "W LOOP S ", 1150, 8950)
SLoopE <- Fwy_interpolate(unmatched, "S LOOP E FWY", 3350, 8450)
SLoopW <- Fwy_interpolate(unmatched, "S LOOP W", 550, 4550)
ELoopN <- Fwy_interpolate(unmatched, "E LOOP N FWY", 250, 3150)
EastFwy <- Fwy_interpolate(unmatched, "EAST FWY", 250, 16250)
Kingwood <- Fwy_interpolate(unmatched, "KINGWOOD DR", 250, 5850)
BarkClod <- Fwy_interpolate(unmatched, "BARKER-CLODINE RD", 1850, 3450)
WLakeHouPkwya <- Fwy_interpolate(unmatched, "W LAKE HOUSTON PKWY", 1350, 6150)
WLakeHouPkwyb <- Fwy_interpolate(unmatched, "W LAKE HOUSTON PKWY", 12650, 15750)
ScottSt <- Fwy_interpolate(unmatched, "SCOTT ST", 10150, 13450)
NWayside <- Fwy_interpolate(unmatched, "N WAYSIDE DR", 350, 10950)
EOrem <- Fwy_interpolate(unmatched, "E OREM DR", 3950, 7550)
WBellAve <- Fwy_interpolate(unmatched, "W BELLFORT AVE", 1650, 11650)

generated <- bind_rows(katy, northfwy, eastex, NSamE, SSamE,
                       ESamS, SSamW, WSamS, Gulf, SouthFwy,
                       SWFwy, Blackhawk, WestheimPkwy, WOrem,
                       WLoopS, SLoopE, SLoopW, ELoopN, EastFwy,
                       Kingwood, BarkClod, WLakeHouPkwya, WLakeHouPkwyb, ScottSt, NWayside,
                       EOrem, WBellAve) 
generated <- bind_rows(generated, WBellAve) 
generated <- unique(generated)

#---------------------------------------
#   E LOOP FWY is special

ELoop <- tribble(
  ~match_address, ~lat, ~long,
  "100 E LOOP FWY , Houston , TX",  29.726086, -95.266590,
  "1000 E LOOP FWY , Houston , TX", 29.738317, -95.265317,
  "3200 E LOOP FWY , Houston , TX", 29.769695, -95.265270
) %>%
  mutate(addr=as.numeric(str_extract(match_address, "^[0-9]+"))) %>% 
  unique() %>% 
  arrange(addr) 
#   Create points to interpolate to
dftargets <- seq(150,3150,by=100)

# interpolate
newlat <- approx(ELoop$addr, ELoop$lat, dftargets)
newlon <- approx(ELoop$addr, ELoop$long, dftargets)

#   Create a new dataframe with all "addresses" in it
newELoop <- tibble(addr=newlat$x, lat=newlat$y, long=newlon$y) %>% 
  mutate(Address=paste0(as.character(addr-50),"-",
                        as.character(addr+49),
                        paste0(" ",toupper("E LOOP FWY"), " , Houston , TX"))) %>% 
  mutate(Beat=NA, n=0, geocode_status="generated", 
         match_address=paste0(as.character(addr)," ","E Loop Fwy", ", Houston, TX"),
         tract=NA, block=NA, status="success") %>% 
  select(Address:match_address,lat, long, tract, block, status)
#---------------------------------------

generated <- bind_rows(generated, newELoop) 

saveRDS(generated, "~/Dropbox/CrimeStats/Generated_Coordinates.rds")


make_kml(WBellAve, "~/testkml.kml")

```

##   Add notes for impossible or useless addresses


```{r add notes}

mask <- grepl("W HOWARD LN", unmatched$RawAddress)
sum(mask)
unmatched[mask,]$GType <- "Parole Board in Austin"

mask <- grepl("14000-14099 E 21ST", unmatched$Address)
sum(mask)
unmatched[mask,]$GType <- "Dept Pub Safety, Tulsa"
unmatched[mask,]$status <- "outside boundary"

mask <- grepl("HOMELESS", unmatched$Address) |
        grepl("PO BOX", unmatched$Address)
sum(mask)
unmatched[mask,]$GType <- NA
unmatched[mask,]$status <- "Not an address"

#   Flag addresses out of range

outofrange <- function(df, mask, min, max){
  number <- as.numeric(getnumber(df))
  mask2 <- (number<min)|(number>max)
  df$status[mask&mask2] <- "address out of range"
  return(df)
}

dataOOR <- tribble(
  ~street, ~min, ~max,
  "ST EMANUEL", 0, 3799,
  "RIESNER", 0, 99,
  "W MONTGOMERY RD", 5600, 11999,
  "LEY RD", 7100, 10399,
  "RUSTIC WOODS", 2800, 4199,
  "SHERMAN ST", 2900, 8099,
  "GATEBROOK DR", 18300, 19499,
  "MYKAWA RD", 5600, 12599,
  "WESTPLACE DR", 8600, 8999
)

unmatched2 <- unmatched
unmatched <- unmatched2

for (i in 1:nrow(dataOOR)){
  mask <- grepl(dataOOR$street[i], unmatched$Address)
  df2 <- unmatched[mask,] %>% 
    select(Address, status) %>% 
    mutate(number=unlist(strsplit(unlist(Address), ","))[1]) %>% 
    mutate(number=as.numeric(trimws(str_extract(number, "^[0-9]+")))) %>%  
    mutate(status = case_when(!between(number,
                                      dataOOR$min[i],
                                      dataOOR$max[i]) ~ 
                                "address out of range",
                                TRUE ~ status))
  unmatched$status[mask] <- df2$status
  
}

```


##   manual points

```{r manual}
###############   special case function
special_case <- function(mydf, mask, address, lat, long){
  if (sum(mask)>0){
    print(paste(sum(mask), "records changed"))
    mydf[mask,]$match_address <- address
    mydf[mask,]$status    <- "success"
    mydf[mask,]$geocode_status    <- "manual redo"
    mydf[mask,]$lat    <- lat
    mydf[mask,]$long   <- long
    mydf[mask,]$GType    <- "RANGE_INTERPOLATED manual"
  }
  return(mydf)
}
#################

specific <- tribble(
  ~block, ~street, ~number, ~lat, ~long, ~zip,
  "10800-10899", "South Dr", "10850", 29.667007, -95.570500, "Houston, TX 77099",
  "10400-10499", "South Dr", "10450", 29.667115, -95.564513, "Houston, TX 77099",
  "10600-10699", "South Dr", "10650", 29.667078, -95.567243, "Houston, TX 77099",
  "10700-10799", "South Dr", "10750", 29.667078, -95.567243, "Houston, TX 77099",
  "10300-10399", "South Dr", "10350", 29.667138, -95.561327, "Houston, TX 77099",
  "5600-5699", "Hollister St", "5650", 29.847883, -95.506000, "Houston, TX 77040",
  "4400-4499", "W AIRPORT BLVD", "4450", 29.641152, -95.445227, "Houston, TX 77045",
  "5400-5499", "W AIRPORT BLVD", "5450", 29.644816, -95.481172, "Houston, TX 77035",
  "4300-4399", "W AIRPORT BLVD", "4350", 29.641610, -95.443444, "Houston, TX 77045",
  "4200-4299", "W AIRPORT BLVD", "4250", 29.642281, -95.442003, "Houston, TX 77045",
  "4100-4199", "W AIRPORT BLVD", "4150", 29.642771, -95.440276, "Houston, TX 77045",
  "4000-4099", "W AIRPORT BLVD", "4010", 29.642832, -95.439407, "Houston, TX 77045",
  "4000-4099", "AIRPORT BLVD", "4050", 29.645491, -95.364362, "Houston, TX 77047",
  "4100-4199", "AIRPORT BLVD", "4150", 29.646209, -95.361036, "Houston, TX 77047",
  "4400-4499", "AIRPORT BLVD", "4450", 29.647289, -95.357674, "Houston, TX 77047",
  "5800-5899", "AIRPORT BLVD", "5850", 29.643527, -95.327636, "Houston, TX 77048",
  "1000-1099", "W LOOP S", "1050", 29.759061, -95.455631, "Houston, TX 77056",
  "1600-1699", "W LOOP S", "1650", 29.750432, -95.455807, "Houston, TX 77056",
  "3200-3299", "W LOOP S", "3250", 29.731214, -95.460200, "Houston, TX 77056",
  "9000-9099", "W LOOP S", "9050", 29.682911, -95.459082, "Houston, TX 77096",
  "1500-1599", "N LOOP E", "1550", 29.813095, -95.353224, "Houston, TX 77009",
  "1600-1699", "N LOOP W", "1650", 29.813286, -95.430293, "Houston, TX 77018",
  "3200-3299", "S LOOP E", "3250", 29.680694, -95.378541, "Houston, TX 77021",
  "8500-8599", "S LOOP E", "8550", 29.707600, -95.270795, "Houston, TX 77017",
  "4400-4499", "S LOOP E", "4450", 29.680889, -95.355898, "Houston, TX 77051",
  "6300-6399", "S LOOP E", "6350", 29.697167, -95.312736, "Houston, TX 77087",
  "400-499", "S LOOP W", "450", 29.680707, -95.383576, "Houston, TX 77054",
  "1300-1399", "S LOOP W", "1350", 29.680271, -95.396981, "Houston, TX 77054",
  "2000-2099", "S LOOP W", "2050", 29.678123, -95.409325, "Houston, TX 77054",
  "3200-3299", "S LOOP W", "3250", 29.677876, -95.428601, "Houston, TX 77054",
  "3700-3799", "S LOOP W", "3750", 29.679373, -95.436484, "Houston, TX 77054",
  "4600-4699", "S LOOP W", "4650", 29.679411, -95.456463, "Houston, TX 77096",
  "100-199", "E LOOP N", "150", 29.726808, -95.266662, "Houston, TX 77012",
  "1500-1599", "W BAY AREA BLVD", "1520", 29.538383, -95.149216, "Friendswood, TX 77546",
  "1700-1799", "W BAY AREA BLVD", "1750", 29.538015, -95.151642, "Friendswood, TX 77598",
  "1800-1899", "W BAY AREA BLVD", "1850", 29.537720, -95.153391, "Friendswood, TX 77598",
  "1500-1599", "KATY FWY", "1550", 29.778391, -95.373110, "Houston, TX 77079",
  "1800-1899", "KATY FWY", "1850", 29.779085, -95.376490, "Houston, TX 77079",
  "2400-2499", "KATY FWY", "2450", 29.776887, -95.385030, "Houston, TX 77079",
  "4100-4199", "KATY FWY", "4150", 29.776631, -95.401711, "Houston, TX 77079",
  "4600-4699", "KATY FWY", "4650", 29.777514, -95.408026, "Houston, TX 77079",
  "6900-6999", "KATY FWY", "6950", 29.779125, -95.449633, "Houston, TX 77079",
  "7400-7499", "KATY FWY", "7450", 29.784061, -95.460265, "Houston, TX 77079",
  "21900-21999", "KATY FWY", "21950", 29.785383, -95.752027, "Houston, TX 77079",
  "3200-3299", "HWY 6", "3250", 29.824879, -95.645518, "Houston, TX 77084",
  "1200-1299", "HWY 6", "1250", 29.788500, -95.644808, "Houston, TX 77084",
  "0-99", "W SAM HOUSTON PKWY S", "50", 29.760935, -95.557981, "Houston, TX 77042",
  "600-699", "W SAM HOUSTON PKWY S", "650", 29.755513, -95.558446, "Houston, TX 77042",
  "3500-3599", "W SAM HOUSTON PKWY S", "3550", 29.727917, -95.558058, "Houston, TX 77042",
  "7500-7599", "W SAM HOUSTON PKWY S", "7550", 29.696097, -95.557109, "Houston, TX 77042",
  "9500-9599", "W SAM HOUSTON PKWY S", "9550", 29.675924, -95.560188, "Houston, TX 77042",
  "10500-10599", "W SAM HOUSTON PKWY S", "10550", 29.662790, -95.558711, "Houston, TX 77099",
  "3500-3599", "S SAM HOUSTON PKWY E", "3550", 29.598001, -95.366877, "Houston, TX 77075",
  "4500-4599", "S SAM HOUSTON PKWY E", "4550", 29.600016, -95.346363, "Houston, TX 77075",
  "10800-10899", "S SAM HOUSTON PKWY E", "10850", 29.601107, -95.218508, "Houston, TX 77075",
  "12400-12499", "S SAM HOUSTON PKWY E", "12450", 29.606051, -95.205483, "Houston, TX 77075",
  "0-99", "N SAM HOUSTON PKWY E", "50", 29.940634, -95.411956, "Houston, TX 77060",
  "200-299", "N SAM HOUSTON PKWY E", "250", 29.940708, -95.403470, "Houston, TX 77060",
  "400-499", "N SAM HOUSTON PKWY E", "450", 29.938779, -95.395268, "Houston, TX 77060",
  "7200-7299", "N SAM HOUSTON PKWY E", "7250", 29.940837, -95.278787, "Houston, TX 77049",
  "9200-9299", "N SAM HOUSTON PKWY E", "9250", 29.934682, -95.254336, "Houston, TX 77049",
  "9800-9899", "N SAM HOUSTON PKWY E", "9850", 29.93431, -95.238619, "Houston, TX 77396",
  "5400-5499", "EAST SAM HOUSTON PKWY S", "5450", 29.629967, -95.171077, "Houston, TX 77505",
  "7900-7999", "EAST SAM HOUSTON PKWY S", "7950", 29.607961, -95.203573, "Houston, TX 77034",
  "2900-2999", "S SAM HOUSTON PKWY W", "2950", 29.597505, -95.425588, "Houston, TX 77047",
  "5000-5099", "S SAM HOUSTON PKWY W", "5050", 29.596710, -95.455496, "Houston, TX 77053",
  "8500-8599", "S SAM HOUSTON PKWY W", "8520", 29.621622, -95.512225, "Houston, TX 77085",
  "11000-11099", "S SAM HOUSTON PKWY W", "11050", 29.646607, -95.541186, "Houston, TX 77031",
  "11800-11899", "S SAM HOUSTON PKWY W", "11850", 29.653035, -95.548597, "Houston, TX 77019",
  "11900-11999", "S SAM HOUSTON PKWY W", "11950", 29.653145, -95.548774, "Houston, TX 77031",
  "12400-12499", "S SAM HOUSTON PKWY W", "12450", 29.657849, -95.555317, "Houston, TX 77031",
  "12400-12499", "KUYKENDAHL RD", "12450", 30.007230, -95.463790, "Houston, TX 77014",
  "1100-1199", "BUSINESS CENTER DR", "1150", 29.789516, -95.568062, "Houston, TX 77043",
  "11200-11299", "GESSNER RD", "11250", 29.931944, -95.545468, "Houston, TX 77064",
  "700-799", "EASTEX FWY", "750", 29.769894, -95.340623, "Houston, TX 77020",
  "21700-21799", "GULF FWY", "21750", 29.513308, -95.120234, "Houston, TX 77598",
  "4800-4899", "SOUTH FWY", "4850", 29.725635, -95.375334, "Houston, TX 77004",
  "5900-5999", "SOUTH FWY", "5950", 29.715740, -95.378703, "Houston, TX 77004",
  "6600-6699", "SOUTH FWY", "6650", 29.704571, -95.374954, "Houston, TX 77021",
  "8600-8699", "SOUTH FWY", "8650", 29.662178, -95.386084, "Houston, TX 77051",
  "13400-13499", "SOUTH FWY", "13450", 29.599470, -95.386879, "Houston, TX 77047",
  "17100-17199", "NORTH FWY", "17150", 30.015162, -95.428258, "Houston, TX 77090",
  "11900-11999", "NORTH FWY", "11950", 29.935831, -95.412294, "Houston, TX 77090",
  "7900-7999", "NORTH FWY", "7950", 29.876105, -95.411553, "Houston, TX 77090",
  "4500-4599", "NORTH FWY", "4550", 29.829037, -95.381250, "Houston, TX 77090",
  "3200-3299", "NORTH FWY", "3250", 29.809028, -95.373510, "Houston, TX 77090",
  "1900-1999", "NORTH FWY", "1950", 29.789212, -95.371742, "Houston, TX 77090",
  "1700-1799", "NORTH FWY", "1750", 29.782459, -95.368440, "Houston, TX 77090",
  "900-999", "NORTH FWY", "950", 29.772458, -95.366249, "Houston, TX 77090",
  "1200-1299", "NORTH FWY", "1250", 29.779877, -95.368609, "Houston, TX 77090",
  "0-99", "EAST FWY", "50", 29.775895, -95.368698, "Houston, TX 77090",
  "100-199", "EAST FWY", "150", 29.772370, -95.367162, "Houston, TX 77090",
  "200-299", "EAST FWY", "250", 29.771408, -95.365627, "Houston, TX 77090",
  "400-499", "EAST FWY", "450", 29.767859, -95.362805, "Houston, TX 77090",
  "1100-1199", "EAST FWY", "1150", 29.767994, -95.356470, "Houston, TX 77090",
  "1600-1699", "EAST FWY", "1650", 29.770213, -95.349542, "Houston, TX 77090",
  "3400-3499", "EAST FWY", "3450", 29.769308, -95.335374, "Houston, TX 77090",
  "4900-4999", "EAST FWY", "4950", 29.774265, -95.321346, "Houston, TX 77090",
  "6900-6999", "EAST FWY", "6950", 29.774400, -95.300651, "Houston, TX 77090",
  "7600-7699", "EAST FWY", "7650", 29.777921, -95.290672, "Houston, TX 77090",
  "8400-8499", "EAST FWY", "8450", 29.777959, -95.278043, "Houston, TX 77090",
  "10100-10199", "EAST FWY", "10150", 29.773801, -95.252826, "Houston, TX 77090",
  "10900-10999", "EAST FWY", "10950", 29.773834, -95.236528, "Houston, TX 77090",
  "12300-12399", "EAST FWY", "12350", 29.770351, -95.219647, "Houston, TX 77090",
  "15100-15199", "EAST FWY", "15150", 29.772281, -95.147342, "Houston, TX 77090",
  "16300-16399", "EAST FWY", "16350", 29.784033, -95.109351, "Houston, TX 77090",
  "200-299", "SOUTHWEST FWY", "250", 29.734055, -95.370700, "Houston, TX 77004",
  "300-399", "SOUTHWEST FWY", "350", 29.732978, -95.375308, "Houston, TX 77004",
  "4000-4099", "SOUTHWEST FWY", "4050", 29.728948, -95.442494,  "Houston, TX 77004",
  "4300-4399", "SOUTHWEST FWY", "4350",  29.730056, -95.448722, "Houston, TX 77004",
  "4700-4799", "SOUTHWEST FWY", "4750", 29.729842, -95.457456, "Houston, TX 77004",
  "5300-5399", "SOUTHWEST FWY", "5350", 29.726006, -95.469649, "Houston, TX 77004",
  "6000-6099", "SOUTHWEST FWY", "6050", 29.725628, -95.488258, "Houston, TX 77004",
  "11700-11799", "SOUTHWEST FWY", "11750", 29.649660, -95.570111, "Houston, TX 77031",
  "24500-24599", "TX-494 LOOP", "24550", 30.046708, -95.249315, "Houston, TX 77339",
  "15000-15099", "WESTHEIMER PKWY", "15050", 29.735528, -95.650637, "Houston, TX 77082",
  "15500-15599", "WESTHEIMER PKWY", "15550", 29.734326, -95.661221, "Houston, TX 77082",
  "16500-16599", "WESTHEIMER PKWY", "16550", 29.726220, -95.672004, "Houston, TX 77082",
  "17000-17099", "WESTHEIMER PKWY", "17050", 29.723075, -95.688888, "Houston, TX 77082",
  "17300-17399", "WESTHEIMER PKWY", "17350", 29.723284, -95.696092, "Houston, TX 77082",
  "18600-18699", "WESTHEIMER PKWY", "18650", 29.726006, -95.713498, "Houston, TX 77082",
  "20100-20199", "WESTHEIMER PKWY", "20150", 29.735431, -95.726657, "Houston, TX 77450",
  "9800-9899", "BLACKHAWK BLVD", "9850", 29.602715, -95.248401, "Houston, TX 77075",
  "9700-9799", "BLACKHAWK BLVD", "9750", 29.604412, -95.249614, "Houston, TX 77075",
  "9600-9699", "BLACKHAWK BLVD", "9650", 29.607201, -95.249989, "Houston, TX 77075",
  "9100-9199", "BLACKHAWK BLVD", "9150", 29.617574, -95.250751, "Houston, TX 77075",
  "9000-9099", "BLACKHAWK BLVD", "9050", 29.624004, -95.248393, "Houston, TX 77075",
  "8400-8499", "BLACKHAWK BLVD", "8450", 29.626156, -95.248490, "Houston, TX 77075",
  "1500-1599", "W OREM DR", "1550", 29.627789, -95.397124, "Houston, TX 77085",
  "5800-5899", "W OREM DR", "5850", 29.627380, -95.471038, "Houston, TX 77085",
  "6100-6199", "W OREM DR", "6150", 29.628336, -95.475469, "Houston, TX 77085",
  "6500-6599", "W OREM DR", "6550", 29.628414, -95.482752, "Houston, TX 77085",
  "6800-6899", "W OREM DR", "6850", 29.626883, -95.488081, "Houston, TX 77085",
  "7100-7199", "W OREM DR", "7150", 29.626978, -95.495790, "Houston, TX 77085",
  "7500-7599", "W OREM DR", "7550", 29.626414, -95.500645, "Houston, TX 77085",
  "8000-8099", "W OREM DR", "8050", 29.625020, -95.504604, "Houston, TX 77085",
  "100-199", "KINGWOOD DR", "150", 30.052437, -95.251232, "Houston, TX 77339",
  "500-599", "KINGWOOD DR", "550", 30.051671, -95.246508, "Houston, TX 77339",
  "1000-1099", "KINGWOOD DR", "1050", 30.049844, -95.241513, "Houston, TX 77339",
  "1400-1499", "KINGWOOD DR", "1450", 30.049467, -95.234434, "Houston, TX 77339",
  "1800-1899", "KINGWOOD DR", "1850", 30.051018, -95.228866, "Houston, TX 77339",
  "2000-2099", "KINGWOOD DR", "2050", 30.050823, -95.221565, "Houston, TX 77339",
  "3200-3299", "KINGWOOD DR", "3250", 30.043189, -95.199624, "Houston, TX 77339",
  "3700-3799", "KINGWOOD DR", "3750", 30.044132, -95.192782, "Houston, TX 77339",
  "4200-4299", "KINGWOOD DR", "4250", 30.048675, -95.187666, "Houston, TX 77339",
  "4500-4599", "KINGWOOD DR", "4550", 30.051069, -95.181002, "Houston, TX 77339",
  "5000-5099", "KINGWOOD DR", "5050", 30.053015, -95.171075, "Houston, TX 77339",
  "5500-5599", "KINGWOOD DR", "5550", 30.053778, -95.163174, "Houston, TX 77339",
  "5700-5799", "KINGWOOD DR", "5750", 30.055118, -95.160204, "Houston, TX 77339",
  "5900-5999", "KINGWOOD DR", "5950", 30.060951, -95.157230, "Houston, TX 77339",
  "19500-19599", "KINGWOOD DR", "19550", 30.052825, -95.253268, "Houston, TX 77339",
  "19600-19699", "KINGWOOD DR", "19650", 30.053252, -95.255972, "Houston, TX 77339",
  "19700-19799", "KINGWOOD DR", "19750", 30.053038, -95.257721, "Houston, TX 77339",
  "20000-20099", "KINGWOOD DR", "20050", 30.052486, -95.262329, "Houston, TX 77339",
  "1200-1299", "W LAKE HOUSTON PKWY", "1250", 30.030579, -95.175336, "Houston, TX 77339",
  "1800-1899", "W LAKE HOUSTON PKWY", "1850", 30.035247, -95.174362, "Houston, TX 77339",
  "3000-3099", "W LAKE HOUSTON PKWY", "3050", 30.050162, -95.184227, "Houston, TX 77339",
  "4300-4399", "W LAKE HOUSTON PKWY", "4350", 30.068740, -95.188491, "Houston, TX 77339",
  "4500-4599", "W LAKE HOUSTON PKWY", "4550", 30.071775, -95.188891, "Houston, TX 77339",
  "5300-5399", "W LAKE HOUSTON PKWY", "5350", 30.079015, -95.191976, "Houston, TX 77339",
  "5500-5599", "W LAKE HOUSTON PKWY", "5550", 30.081320, -95.191558, "Houston, TX 77339",
  "6200-6299", "W LAKE HOUSTON PKWY", "6250", 30.091631, -95.190809, "Houston, TX 77339",
  "12500-12599", "W LAKE HOUSTON PKWY", "12550", 29.924576, -95.199962, "Houston, TX 77339",
  "13600-13699", "W LAKE HOUSTON PKWY", "13650", 29.924604, -95.188198, "Houston, TX 77339",
  "14000-14099", "W LAKE HOUSTON PKWY", "14050", 29.929561, -95.177065, "Houston, TX 77339",
  "14200-14299", "W LAKE HOUSTON PKWY", "14250", 29.931229, -95.176466, "Houston, TX 77339",
  "15200-15299", "W LAKE HOUSTON PKWY", "15250", 29.947203, -95.174896, "Houston, TX 77339",
  "15800-15899", "W LAKE HOUSTON PKWY", "15850", 29.956555, -95.171688, "Houston, TX 77339",
  "200-299", "N WAYSIDE DR", "250", 29.759568, -95.294591, "Houston, TX 77020",
  "700-799", "N WAYSIDE DR", "750", 29.762834, -95.294487, "Houston, TX 77020",
  "1000-1099", "N WAYSIDE DR", "1050", 29.769176, -95.293332, "Houston, TX 77020",
  "1200-1299", "N WAYSIDE DR", "1250", 29.772140, -95.291516, "Houston, TX 77020",
  "2300-2399", "N WAYSIDE DR", "2350", 29.786729, -95.291771, "Houston, TX 77020",
  "2500-2599", "N WAYSIDE DR", "2550", 29.787420, -95.291728, "Houston, TX 77020",
  "3400-3499", "N WAYSIDE DR", "3450", 29.793688, -95.289662, "Houston, TX 77020",
  "4700-4799", "N WAYSIDE DR", "4750", 29.803699, -95.284603, "Houston, TX 77020",
  "7300-7399", "N WAYSIDE DR", "7350", 29.828340, -95.284398, "Houston, TX 77020",
  "9200-9299", "N WAYSIDE DR", "9250", 29.846931, -95.284617, "Houston, TX 77020",
  "9400-9499", "N WAYSIDE DR", "9450", 29.849120, -95.284778, "Houston, TX 77020",
  "9700-9799", "N WAYSIDE DR", "9750", 29.854286, -95.282224, "Houston, TX 77020",
  "10500-10599", "N WAYSIDE DR", "10550", 29.863416, -95.281492, "Houston, TX 77020",
  "10800-10899", "N WAYSIDE DR", "10850", 29.870465, -95.281617, "Houston, TX 77020",
  "11000-11099", "N WAYSIDE DR", "11050", 29.875573, -95.280340, "Houston, TX 77020",
  "1500-1599", "W BELLFORT AVE", "1550", 29.673346, -95.399771, "Houston, TX 77054",
  "1700-1799", "W BELLFORT AVE", "1750", 29.672729, -95.403845, "Houston, TX 77054",
  "1900-1999", "W BELLFORT AVE", "1950", 29.672748, -95.410883, "Houston, TX 77054",
  "2900-2999", "W BELLFORT AVE", "2950", 29.672445, -95.423994, "Houston, TX 77054",
  "3100-3199", "W BELLFORT AVE", "3150", 29.672343, -95.429326, "Houston, TX 77054",
  "3600-3699", "W BELLFORT AVE", "3650", 29.672850, -95.435746, "Houston, TX 77025",
  "3800-3899", "W BELLFORT AVE", "3850", 29.673242, -95.438794, "Houston, TX 77025",
  "4600-4699", "W BELLFORT AVE", "4650", 29.673056, -95.455478, "Houston, TX 77025",
  "4900-4999", "W BELLFORT AVE", "4950", 29.669541, -95.464962, "Houston, TX 77025",
  "5300-5399", "W BELLFORT AVE", "5350", 29.658484, -95.478051, "Houston, TX 77025",
  "6200-6299", "W BELLFORT AVE", "6250", 29.657055, -95.499293, "Houston, TX 77025",
  "6300-6399", "W BELLFORT AVE", "6350", 29.656160, -95.502651, "Houston, TX 77025",
  "9400-9499", "W BELLFORT AVE", "9450", 29.656011, -95.544853, "Houston, TX 77025",
  "9800-9899", "W BELLFORT AVE", "9850", 29.652810, -95.552244, "Houston, TX 77025",
  "10400-10499", "W BELLFORT AVE", "10450", 29.652796, -95.561557, "Houston, TX 77025",
  "11600-11699", "W BELLFORT AVE", "11650", 29.658357, -95.580670, "Houston, TX 77025",
  "11700-11799", "W BELLFORT AVE", "11750", 29.657518, -95.584806, "Houston, TX 77025",
  "6100-6199", "GOLF COURSE DR", "6150", 29.715991, -95.388487, "Houston, TX 77030",
  "6200-6299", "GOLF COURSE DR", "6250", 29.714229, -95.388639, "Houston, TX 77030"
)

for (i in 1:nrow(specific)) {
  mask <- grepl(paste(specific[i,]$block, specific[i,]$street), 
                unmatched$Address, ignore.case=TRUE)
  print(paste(specific[i,]$street, sum(mask)))
  unmatched <- special_case(unmatched, 
                   mask, 
                   paste0(specific[i,]$number, " ", 
                          specific[i,]$street, ", ",
                          specific[i,]$zip),
                  specific[i,]$lat, 
                  specific[i,]$long 
                   )
}

saveRDS(unmatched, "~/Dropbox/CrimeStats/GeoTable_temp.rds")

```


```{r GetLatLongGoogle}

#   Function for pulling fields out of nested lists returned by geocode
getfields <- function(x){
              if(! is.na(x) && length(x$results)>0)  {tibble(
              lat=as.numeric(x$results[[1]]$geometry$location$lat),
              long=as.numeric(x$results[[1]]$geometry$location$lng),
              match_address=x$results[[1]]$formatted_address,
              LocType=x$results[[1]]$geometry$location_type,
              Type=unlist(x$results[[1]]$types[1])
              )
              } else if ("status" %in% names(x) &&
                         x$status=="ZERO_RESULTS"){
                tibble(Type=x$status,lat=NA,long=NA,
                           match_address=NA,LocType=NA )
              } else{
                tibble(Type=NA,lat=NA,long=NA,
                           match_address=NA,LocType=NA )
              }
}

#     Process google results and check for accuracy

GetLatLongGoogle <- function(address, newaddr){
  # prepare address
  x <- unlist(strsplit(unlist(address), ","))
  city <- trimws(x[2])
  state <- trimws(x[3])
  adr <- unlist(strsplit(str_extract(x[1], "^[0-9]+-[0-9]+"),"-"))[1]
  adr <- str_replace(adr, "00$", newaddr)
  adr <- str_replace(adr, "^0$", newaddr)
  street <- trimws(sub("^[0-9]+-[0-9]+", "", x[1]))
  address <- paste(adr, street, ",", city, ",", state)
  
  #   get results from given address
  
  #GoogleResults <- geocode(address, output="all")
  GoogleResults <- geocode(address, output="all", inject=BoundBox)
  LatLong1 <- getfields(GoogleResults)
  
  #   Did we error?
  
  if (is.na(LatLong1$Type) |
      LatLong1$Type == "ZERO_RESULTS"){
          LatLong1$status <- "no result"
          return(LatLong1)
      }
  
  #   Are we within the city?
  
  if (!between(LatLong1$lat, HoustonBdy[2], HoustonBdy[4]) |
      !between(LatLong1$long, HoustonBdy[1], HoustonBdy[3])){
          LatLong1$status <- "outside boundary"
          return(LatLong1)
      }
  
  #   Is it a bogus location at center of long street?
  
  if (LatLong1$LocType == "GEOMETRIC_CENTER") { # bad location
          LatLong1$status <- "Road only, street number ignored"
          return(LatLong1)
  }
  
  # REALLY bogus location - don't want this
    
  if (LatLong1$LocType == "APPROXIMATE" ) { # bad location
          LatLong1$status <- "City only, street ignored"
          return(LatLong1)
  }
  
  #   Is the match name "close enough"?
  x <- unlist(strsplit(unlist(LatLong1$match_address), ","))
  #utstreet <- trimws(sub("^[0-9]+", "", x[1]))
  utstreet <- trimws(x[1])
  adr <- str_remove(adr, "^0")
  if (tolower(paste(adr,street)) != tolower(utstreet)){
          LatLong1$status <- "Names mismatch"
          return(LatLong1)
  }
  
  #   Now tweak the street number and get a new set
  #   unless LocType == "ROOFTOP"
  
  if (LatLong1$LocType != "ROOFTOP") { # interpolated location
      addrnumber <- trimws(str_extract(address, "^[0-9]+ "))
      if (as.numeric(addrnumber)>50){
        addrnumber2 <- as.character(as.numeric(addrnumber)-16)
      } else {
        addrnumber2 <- as.character(as.numeric(addrnumber)+16)
      }
      address <- str_replace(address, addrnumber, addrnumber2)
      GoogleResults <- geocode(address, output="all")
      LatLong2 <- getfields(GoogleResults)
        
    #   Are the answers the same? If so, we have a problem
      distance <- dist(rbind(c(LatLong1$lat, LatLong1$long),
                        c(LatLong2$lat, LatLong2$long))) *
                        69*5280
      if (distance < 10){# could be almost anywhere, reject
          LatLong1$status <- paste("Distance =",as.character(distance))
          return(LatLong1)
      }
  }
  #   All the tests passed, successful return
        LatLong1$status <- "success"
        return(LatLong1)
  
}

```

##    function to calculate distance from point to beat

```{r jumptothebeat}

Beats <- read_sf('/home/ajackson/Dropbox/CrimeStats/BeatPolys/Houston_Police_Beats.shp')

#     test data
long <-  -95.3865378
lat  <-   29.6436889
beat <- "19G50"

jumptothebeat <- function(lat, long, beat){
  
  temp <- tribble(~lat, ~long, lat, long) %>% 
    st_as_sf(coords=c("long", "lat"),
                    crs=googlecrs, agr = "identity")
  
  Beats %>% filter(Beats==beat) %>% 
     st_distance(temp, by_element = TRUE)
}
```


```{r run google}

unmatched2 <- unmatched

#    special cases - digits replace last 2 on address
special <- tribble(
  ~match, ~addr,
  "12499 SOUTH DR",          "31",
  "12399 SOUTH DR",          "35",
  "12199 SOUTH DR",          "03",
  "7499 HOLLISTER ST",       "25",
  "8399 BROADWAY ST",        "26",
  "3599 W AIRPORT",          "06",
  "3499 W AIRPORT",          "30",
  "3399 W AIRPORT",          "39",
  "1899 AIRPORT",            "42",
  "1999 AIRPORT",            "90",
  "7599 SOUTH FWY",          "47",
  "7699 SOUTH FWY",          "41",
  "9199 SOUTH FWY",          "00",
  "12699 SOUTH FWY",         "02",
  "12799 SOUTH FWY",         "51",
  "12999 SOUTH FWY",         "62",
  "13099 SOUTH FWY",         "91",
  "13199 SOUTH FWY",         "10",
  "13499 SOUTH FWY",         "19",
  "13899 SOUTH FWY",         "22",
  "1599 W BAY AREA",         "05",
  "1899 W BAY AREA",         "55",
  "1499 W BAY AREA",         "53",
  "1799 W BAY AREA",         "35",
  "1399 W BAY AREA",         "33",
  "7999 S SAM HOUSTON PKWY E","09",
  "5499 W LOOP S ",          "10",
  "8799 W LOOP S ",          "05",
  "8599 W LOOP S ",          "15",
  "5699 W LOOP S ",          "01",
  "1499 W LOOP S ",          "49",
  "1399 W LOOP S ",          "33",
  "1299 W LOOP S ",          "33",
  "1199 W LOOP S ",          "77",
  "5599 W LOOP S ",          "05",
  "5399 W LOOP S ",          "45",
  "CENTRAL GREEN BLVD",      "00"
)

onlys <- c("SOUTH FWY", "BAY AREA BLVD", "AIRPORT BLVD")
onlys <- c("W LOOP S")

##########################################
##    next spin through data geocoding
##########################################

begin <- 1
successes <- 0
trys <- 0
for (i in begin:nrow(unmatched)) {
  if (i==begin){starttime <- now()}
  if (unmatched[i,]$status=="redo" |
      unmatched[i,]$geocode_status=="redo fail"){ 
    
    # only do selected cases
    #if (!any(str_detect(unmatched[i,]$Address, onlys))){next()}
    
    trys <- trys + 1
    print(paste("--->",i,unmatched[i,1], 
                format(Sys.time(), "%a %b %d %X %Y"),
                now()+((now()-starttime)/trys)*(nrow(unmatched)-i)
          ))
    #print(paste("--->",i,unmatched[i,1], 
    #            format(Sys.time(), "%a %b %d %X %Y")))
    # Did I already succeed at this match somewhere?
    #a <- check_match(unmatched[i,]$Address, previous_match)
    #if (is_tibble(a)) {
    #  unmatched[i,4:10] <- a[1,4:10]
    #  print("found previous match in archive")
    #  next
    #}
    #a <- check_match(unmatched[i,]$Address, unmatched)
    #if (is_tibble(a)) {
    # unmatched[i,4:10] <- a[1,4:10]
    #  print("found previous match in current")
    #  next
    #}

      # pick a random address to try
    newaddr <- str_pad(as.character(sample(0:50, 1)),2,pad="0")
    
      # Use a given address
    if(any(str_detect(unmatched[i,]$Address, special$match))){
      newaddr <- special[str_detect(unmatched[i,]$Address,
                                    special$match),]$addr
    }
    #   Call google
    
    latlong <- GetLatLongGoogle( unmatched[i,]$Address, newaddr)
    if (latlong$status=="success") {
      unmatched[i,]$distance <- jumptothebeat(latlong$lat, 
                                latlong$long, 
                                unmatched[i,]$Beat)
      print(paste("=======success======="))
      unmatched[i,]$match_address  <- latlong$match_address
      unmatched[i,]$lat            <- latlong$lat
      unmatched[i,]$long           <- latlong$long
      unmatched[i,]$geocode_status <- "google redo"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
    } else if (latlong$status=="Names mismatch"){
      print(paste("=======fail=======",latlong[1,]))
      unmatched[i,]$geocode_status <- "redo fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    } else{
      print(paste("=======fail======="))
      unmatched[i,]$geocode_status <- "redo fail"
      unmatched[i,]$status         <- latlong$status
      unmatched[i,]$GType          <- paste(latlong$LocType, latlong$Type)
      unmatched[i,]$match_address  <- latlong$match_address
    }
  }
  if ((i+1)%%100 == 0){
    saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_redo.rds")
    
  }
}

#   Percent of unique addresses found, and percent of total found

unmatched %>% 
  group_by(geocode_status) %>% 
  summarise(n=n())


```

##    Add beat distance to *all* success records

```{r add beat distance}

begin <- 72951
trys <- 0
for (i in begin:nrow(unmatched)) {
  if (i==begin){starttime <- now()}
  if (unmatched[i,]$status=="success" &
      is.na(unmatched[i,]$distance)){ 
    
    trys <- trys + 1
    print(paste("--->",i,unmatched[i,1], 
                format(Sys.time(), "%a %b %d %X %Y"),
                now()+((now()-starttime)/trys)*(nrow(unmatched)-i)
          ))

      unmatched[i,]$distance <- jumptothebeat(
                                unmatched[i,]$lat, 
                                unmatched[i,]$long, 
                                unmatched[i,]$Beat)

    if ((trys)%%100 == 0){
      saveRDS(unmatched, "~/Dropbox/CrimeStats/CensusGeoTable_progress_redo.rds")
    } 
  }
}

```

```{r Save intermediate finals}

saveRDS(unmatched, "~/Dropbox/CrimeStats/GeoTable_03Aug2019.rds")

unmatched <- readRDS("~/Dropbox/CrimeStats/GeoTable_03Aug2019.rds")
```

## Pull out redos

For n>5 and distance > 2000, look at these individually and try to fix.


```{r pull out cases that need redo}

redos <- unmatched %>% 
  filter(distance>=2000 & n >=5)

```


##    Some generated segments are bad

Fix W Loop S Fwy
    S Sam Houston Pkwy E (7909)



